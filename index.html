<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Colecta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #0f172a 0%, #581c87 50%, #0f172a 100%);
        }

        .card-glass {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(168, 85, 247, 0.2);
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield;
        }

        /* Estilos para el modal */
        #machineModal {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Estilos para el modal */
        #machineModal {
            animation: fadeIn 0.3s ease;
        }

        #machineModal.fade-out {
            animation: fadeOut 0.2s ease forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        /* Mejorar la legibilidad del modal */
        #machineModal .card-glass {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(20px);
        }

        /* Estilos para notificaciones */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 99999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 320px;
        }

        .notification {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            transform: translateX(400px);
            opacity: 0;
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55), opacity 0.3s;
            position: relative;
            overflow: hidden;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification.hide {
            transform: translateX(400px);
            opacity: 0;
        }

        .notification::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, #8b5cf6, #ec4899);
        }

        .notification-success::before {
            background: linear-gradient(to bottom, #10b981, #34d399);
        }

        .notification-error::before {
            background: linear-gradient(to bottom, #ef4444, #f87171);
        }

        .notification-warning::before {
            background: linear-gradient(to bottom, #f59e0b, #fbbf24);
        }

        .notification-info::before {
            background: linear-gradient(to bottom, #3b82f6, #60a5fa);
        }

        .notification-content {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .notification-icon {
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .notification-success .notification-icon {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .notification-error .notification-icon {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .notification-warning .notification-icon {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .notification-info .notification-icon {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .notification-text {
            flex: 1;
        }

        .notification-title {
            font-weight: 700;
            color: white;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .notification-message {
            color: #cbd5e1;
            font-size: 13px;
            line-height: 1.4;
        }

        .notification-close {
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 16px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .notification-close:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .notification-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: rgba(255, 255, 255, 0.1);
        }

        .notification-progress-bar {
            height: 100%;
            width: 100%;
            background: linear-gradient(to right, #8b5cf6, #ec4899);
            transform-origin: left;
            transform: scaleX(1);
            transition: transform linear;
        }

        .notification-success .notification-progress-bar {
            background: linear-gradient(to right, #10b981, #34d399);
        }

        .notification-error .notification-progress-bar {
            background: linear-gradient(to right, #ef4444, #f87171);
        }

        .notification-warning .notification-progress-bar {
            background: linear-gradient(to right, #f59e0b, #fbbf24);
        }

        .notification-info .notification-progress-bar {
            background: linear-gradient(to right, #3b82f6, #60a5fa);
        }

        /* Agrega esto al <style> */
        html {
            scroll-behavior: smooth;
        }

        /* Estilo adicional para cuando el campo estado tiene foco */
        #estado:focus {
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.3);
        }

        /* Estilos para navegaci√≥n por tabs */
        .nav-tab {
            transition: all 0.3s ease;
            background: transparent;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 600;
            cursor: pointer;
            border: none;
            font-size: 14px;
        }

        .nav-tab.active {
            color: white;
            background: rgba(168, 85, 247, 0.2);
            border-bottom: 3px solid #a855f7;
        }

        .nav-tab:hover:not(.active) {
            color: rgba(255, 255, 255, 0.9);
            background: rgba(168, 85, 247, 0.1);
        }

        /* Animaciones para transiciones de p√°gina */
        .fade-in {
            animation: fadeInUp 0.3s ease-out forwards;
        }

        .fade-out {
            animation: fadeOutDown 0.2s ease-out forwards;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeOutDown {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }

        /* Estilos para scrollbar personalizado */
        .overflow-y-auto::-webkit-scrollbar {
            width: 8px;
        }

        .overflow-y-auto::-webkit-scrollbar-track {
            background: rgba(71, 85, 105, 0.3);
            border-radius: 4px;
        }

        .overflow-y-auto::-webkit-scrollbar-thumb {
            background: rgba(168, 85, 247, 0.6);
            border-radius: 4px;
        }

        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: rgba(168, 85, 247, 0.8);
        }

        /* Para Firefox */
        .overflow-y-auto {
            scrollbar-width: thin;
            scrollbar-color: rgba(168, 85, 247, 0.6) rgba(71, 85, 105, 0.3);
        }
    </style>
</head>

<body class="gradient-bg min-h-screen p-4">

    <!-- P√°gina de Colecta (contenido existente del formulario) -->
    <div id="colectaPage" class="hidden">
        <!-- Header de la p√°gina de colecta - Todo en una l√≠nea -->
        <div class="max-w-4xl mx-auto mb-4">
            <div class="card-glass rounded-xl p-3 shadow-xl">
                <div class="flex items-center justify-between">
                    <!-- Izquierda: Empresa y RUC -->
                    <div class="min-w-0">
                        <h3 class="text-base font-bold text-white truncate mb-0.5">LORENS GAMING S.A</h3>
                        <p class="text-xs text-white">RUC: 1813975-1-707784 DV 54</p>
                    </div>

                    <!-- Derecha: Botones (Dashboard y Agregar M√°quinas) -->
                    <div class="flex gap-2">
                        <button onclick="navigateTo('dashboard')"
                                class="nav-tab w-10 h-10 flex items-center justify-center rounded-lg text-xl"
                                data-page="dashboard"
                                title="Volver al Dashboard">
                            üìä
                        </button>
                        <button id="btnAdd"
                                class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-500 text-white font-bold rounded-lg hover:from-blue-600 hover:to-cyan-600 transition-all shadow flex items-center justify-center hover:scale-105 active:scale-95 text-xl"
                                title="Agregar M√°quinas">
                            ‚ûï
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Container de M√°quinas -->
        <div class="max-w-4xl mx-auto space-y-3" id="machinesContainer"></div>

    <!-- Resumen Total -->
    <div class="max-w-4xl mx-auto mt-4">
        <div class="card-glass rounded-xl p-4 shadow-xl">

            <!-- Elementos ocultos para c√°lculos (necesarios para JavaScript) -->
            <div style="display: none;">
                <span id="totalEntradas">$0</span>
                <span id="totalPagos">$0</span>
            </div>

            <!-- Impuesto y Devoluci√≥n -->
            <div class="grid grid-cols-2 gap-3 mb-3">
                <!-- Impuesto JCJ -->
                <div class="bg-slate-800 bg-opacity-50 rounded-lg p-3 border border-purple-500 border-opacity-20">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-xs font-medium text-white">IMP. JCJ</label>
                        <span class="text-xs text-slate-400">Total:</span>
                    </div>

                    <!-- Fila 1: Valor y cantidad -->
                    <div class="flex items-center gap-1 mb-2">
                        <div class="flex-1">
                            <p class="text-xs text-slate-400 mb-1">Valor</p>
                            <input type="number" id="impuestoPorMaquina"
                                class="w-full bg-slate-700 border border-purple-500 border-opacity-30 rounded px-2 py-1.5 text-white text-center font-bold focus:outline-none focus:border-purple-500 text-sm"
                                value="0" placeholder="0.00" step="0.01">
                        </div>
                        <div class="text-center pt-3">
                            <span class="text-white text-md">√ó</span>
                        </div>
                        <div class="flex-1">
                            <p class="text-xs text-slate-400 mb-1">Cant.</p>
                            <input type="number" id="multiplicadorImpuesto"
                                class="w-full bg-slate-800 border border-blue-500 border-opacity-30 rounded px-2 py-1.5 text-white text-center font-bold focus:outline-none focus:border-blue-500 text-sm"
                                value="1" min="1">
                        </div>
                    </div>

                    <!-- Fila 2: Total -->
                    <div>
                        <input type="number" id="impuestoJCJ" readonly
                            class="w-full bg-slate-900 border border-green-500 border-opacity-30 rounded px-2 py-1.5 text-green-400 text-center font-bold text-sm"
                            value="0">
                    </div>
                </div>

                <!-- Devoluci√≥n -->
                <div class="bg-slate-800 bg-opacity-50 rounded-lg p-3 border border-purple-500 border-opacity-20">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-xs font-medium text-white">DEVOLUCI√ìN</label>
                        <span class="text-xs text-slate-400">Total:</span>
                    </div>

                    <!-- Fila 1: Valor y cantidad -->
                    <div class="flex items-center gap-1 mb-2">
                        <div class="flex-1">
                            <p class="text-xs text-slate-400 mb-1">Valor</p>
                            <input type="number" id="devolucionPorMaquina"
                                class="w-full bg-slate-700 border border-purple-500 border-opacity-30 rounded px-2 py-1.5 text-white text-center font-bold focus:outline-none focus:border-purple-500 text-sm"
                                value="0" placeholder="0.00" step="0.01">
                        </div>
                        <div class="text-center pt-3">
                            <span class="text-white text-md">√ó</span>
                        </div>
                        <div class="flex-1">
                            <p class="text-xs text-slate-400 mb-1">Cant.</p>
                            <input type="number" id="multiplicadorDevolucion"
                                class="w-full bg-slate-800 border border-blue-500 border-opacity-30 rounded px-2 py-1.5 text-white text-center font-bold focus:outline-none focus:border-blue-500 text-sm"
                                value="1" min="1">
                        </div>
                    </div>

                    <!-- Fila 2: Total -->
                    <div>
                        <input type="number" id="devolucion" readonly
                            class="w-full bg-slate-900 border border-green-500 border-opacity-30 rounded px-2 py-1.5 text-green-400 text-center font-bold text-sm"
                            value="0">
                    </div>
                </div>
            </div>

            <!-- Fallas y Premios Pendientes -->
            <div class="grid grid-cols-2 gap-3 mb-3">
                <div class="bg-slate-800 bg-opacity-50 rounded-lg p-3 border border-purple-500 border-opacity-20">
                    <label class="block text-xs font-medium text-white mb-2">FALLAS O PRUEBAS</label>
                    <input type="number" id="fallasOPruebas"
                        class="w-full bg-slate-700 border border-purple-500 border-opacity-30 rounded px-2 py-1.5 text-white text-center font-bold focus:outline-none focus:border-purple-500 text-sm"
                        value="0" placeholder="0">
                </div>
                <div class="bg-slate-800 bg-opacity-50 rounded-lg p-3 border border-purple-500 border-opacity-20">
                    <label class="block text-xs font-medium text-white mb-2">PREMIOS PENDIENTES</label>
                    <input type="number" id="premiosPendientes"
                        class="w-full bg-slate-700 border border-purple-500 border-opacity-30 rounded px-2 py-1.5 text-white text-center font-bold focus:outline-none focus:border-purple-500 text-sm"
                        value="0" placeholder="0">
                </div>
            </div>

            <!-- Observaciones -->
            <div class="mb-3"><label class="block text-xs font-medium text-white mb-1">OBSERVACIONES:</label>
                <textarea id="observaciones"
                    class="w-full bg-slate-700 border border-purple-500 border-opacity-30 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-purple-500 h-16 resize-none"
                    placeholder="Notas adicionales..."></textarea>
            </div>

            <!-- Estado -->
            <div class="mb-3">
                <label class="block text-xs font-medium text-white mb-1">ESTADO:</label>
                <div class="relative">
                    <input type="text" id="estado" readonly
                        class="w-full bg-slate-700 border border-purple-500 border-opacity-30 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50 transition-all duration-300 placeholder:text-slate-500"
                        placeholder="Estado del env√≠o a la nube...">
                    <div class="absolute inset-y-0 right-3 flex items-center pointer-events-none">
                        <span class="text-xs text-slate-400 transition-all duration-300" id="estadoIcon">üì°</span>
                    </div>
                </div>
                <p class="text-xs text-slate-500 mt-1">Se actualizar√° al guardar</p>
            </div>
            <!-- Bot√≥n MAS -->
            <div class="mb-3">
                <button id="btnMas" type="button"
                    class="w-full bg-slate-700 border border-purple-500 border-opacity-30 rounded-lg px-3 py-2 text-white font-semibold hover:bg-slate-600 transition-all flex items-center justify-between">
                    <span id="masLabel">MAS:</span>
                    <svg id="masArrow" class="w-5 h-5 transition-transform" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>

                <!-- Contenedor para opciones seleccionadas (siempre visible si hay selecciones) -->
                <div id="masSeleccionadas" class="hidden mt-2 space-y-2">
                    <!-- Las opciones seleccionadas se agregar√°n aqu√≠ din√°micamente -->
                </div>

                <!-- Contenedor para TODAS las opciones (solo visible al hacer clic en MAS) -->
                <div id="masTodasOpciones" class="hidden mt-2 space-y-2">
                    <!-- ABONO -->
                    <div class="mas-option-group" data-option="abono">
                        <label
                            class="flex items-center gap-2 bg-slate-700 bg-opacity-50 rounded-lg p-2 cursor-pointer hover:bg-opacity-70 transition-all">
                            <input type="checkbox" class="w-4 h-4 mas-option-checkbox" data-option="abono">
                            <span class="text-sm text-white font-medium">ABONO</span>
                        </label>
                    </div>

                    <!-- DIF% -->
                    <div class="mas-option-group" data-option="dif">
                        <label
                            class="flex items-center gap-2 bg-slate-700 bg-opacity-50 rounded-lg p-2 cursor-pointer hover:bg-opacity-70 transition-all">
                            <input type="checkbox" class="w-4 h-4 mas-option-checkbox" data-option="dif">
                            <span class="text-sm text-white font-medium">DIF%</span>
                        </label>
                    </div>

                    <!-- DEPOSITO -->
                    <div class="mas-option-group" data-option="deposito">
                        <label
                            class="flex items-center gap-2 bg-slate-700 bg-opacity-50 rounded-lg p-2 cursor-pointer hover:bg-opacity-70 transition-all">
                            <input type="checkbox" class="w-4 h-4 mas-option-checkbox" data-option="deposito">
                            <span class="text-sm text-white font-medium">DEPOSITO</span>
                        </label>
                    </div>

                    <!-- PENDIENTE -->
                    <div class="mas-option-group" data-option="pendiente">
                        <label
                            class="flex items-center gap-2 bg-slate-700 bg-opacity-50 rounded-lg p-2 cursor-pointer hover:bg-opacity-70 transition-all">
                            <input type="checkbox" class="w-4 h-4 mas-option-checkbox" data-option="pendiente">
                            <span class="text-sm text-white font-medium">PENDIENTE</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Inputs de las opciones MAS - Dise√±o uniforme -->
            <div id="optionAbono" class="hidden mb-3">
                <div class="bg-slate-800 bg-opacity-50 rounded-lg p-3 border border-purple-500 border-opacity-20">
                    <label class="block text-xs font-medium text-white mb-2">ABONO</label>
                    <input type="number" id="abono"
                        class="w-full bg-slate-700 border border-purple-500 border-opacity-30 rounded px-2 py-1.5 text-white text-center font-bold focus:outline-none focus:border-purple-500 text-sm"
                        value="0" placeholder="Monto">
                </div>
            </div>

            <div id="optionDif" class="hidden mb-3">
                <div class="bg-slate-800 bg-opacity-50 rounded-lg p-3 border border-purple-500 border-opacity-20">
                    <label class="block text-xs font-medium text-white mb-2">DIF%</label>
                    <input type="number" id="difPorcentaje"
                        class="w-full bg-slate-700 border border-purple-500 border-opacity-30 rounded px-2 py-1.5 text-white text-center font-bold focus:outline-none focus:border-purple-500 text-sm"
                        value="0" placeholder="Porcentaje">
                </div>
            </div>

            <div id="optionDeposito" class="hidden mb-3">
                <div class="bg-slate-800 bg-opacity-50 rounded-lg p-3 border border-purple-500 border-opacity-20">
                    <label class="block text-xs font-medium text-white mb-2">DEP√ìSITO</label>
                    <input type="number" id="deposito"
                        class="w-full bg-slate-700 border border-purple-500 border-opacity-30 rounded px-2 py-1.5 text-white text-center font-bold focus:outline-none focus:border-purple-500 text-sm"
                        value="0" placeholder="Monto">
                </div>
            </div>

            <div id="optionPendiente" class="hidden mb-3">
                <div class="bg-slate-800 bg-opacity-50 rounded-lg p-3 border border-purple-500 border-opacity-20">
                    <label class="block text-xs font-medium text-white mb-2">PENDIENTE</label>
                    <input type="number" id="pendiente"
                        class="w-full bg-slate-700 border border-purple-500 border-opacity-30 rounded px-2 py-1.5 text-white text-center font-bold focus:outline-none focus:border-purple-500 text-sm"
                        value="0" placeholder="Monto">
                </div>
            </div>
            <!-- Resultados Finales -->
            <div
                class="bg-slate-800 bg-opacity-50 rounded-lg p-3 mb-3 space-y-2 border border-purple-500 border-opacity-20">
                <!-- T√≠tulo Resumen Total con estilo especial -->
                <div class="bg-gradient-to-r from-slate-700 to-slate-600 rounded-lg p-2 mb-3 text-center">
                    <h3 class="text-lg font-bold text-white">RESUMEN TOTAL</h3>
                </div>
                <div class="flex justify-between text-sm"><span class="text-slate-300">COLECTADO:</span><span
                        class="text-white font-bold" id="colectado">0</span></div>
                <div class="flex justify-between text-sm"><span class="text-slate-300">PREMIOS:</span><span
                        class="text-white font-bold" id="premios">0</span></div>
                <div class="flex justify-between text-sm"><span class="text-slate-300">RETENCI√ìN 5.5%:</span><span
                        class="text-white font-bold" id="retencion">0</span></div>
                <div class="flex justify-between text-sm"><span class="text-slate-300">PREMIOS NETO:</span><span
                        class="text-red-400 font-bold" id="premiosNeto">0</span></div>
                <div class="flex justify-between text-sm"><span class="text-slate-300">IMPUESTO JCJ:</span><span
                        class="text-white font-bold" id="impuestoDisplay">0</span></div>
                <div class="flex justify-between text-sm"><span class="text-slate-300">DEVOLUCI√ìN:</span><span
                        class="text-white font-bold" id="devolucionDisplay">0</span></div>
                <div class="flex justify-between text-sm border-t border-slate-600 pt-2"><span class="text-slate-300">A
                        REPARTIR:</span><span class="text-white font-bold" id="aRepartir">0</span></div>
                <div class="flex justify-between text-sm"><span class="text-slate-300">GANANCIA C/U:</span><span
                        class="text-white font-bold" id="gananciaCU">0</span></div>
                <div class="flex justify-between text-sm"><span class="text-slate-300">GANANCIA CLIENTE:</span><span
                        class="text-white font-bold" id="gananciaCliente">0</span></div>
                <div class="flex justify-between text-sm border-t border-slate-600 pt-2"><span
                        class="text-slate-300 font-bold">RECIBIDO CLIENTE:</span><span
                        class="text-green-400 font-bold text-lg" id="recibidoCliente">0</span></div>
                <div class="flex justify-between text-sm"><span class="text-slate-300">EMPRESA JCJ & LUCRO:</span><span
                        class="text-white font-bold" id="empresaJCJ">0</span></div>
                <div class="flex justify-between text-sm border-t border-slate-600 pt-2"><span
                        class="text-slate-300 font-bold">RECIBIDO EMPRESA:</span><span
                        class="text-white font-bold text-lg" id="recibidoEmpresa">0</span></div>
                <div class="flex justify-between items-center bg-gradient-to-r from-slate-700 to-slate-600 rounded p-2 mt-2"><span
                        class="text-white font-bold">A RECIBIR:</span><span class="text-yellow-300 font-bold text-xl"
                        id="aRecibir">0</span></div>
            </div>

            <!-- Establecimiento Actual -->
            <div class="mt-6 mb-4 border-t border-purple-500 border-opacity-30 pt-4">
                <div class="bg-gradient-to-r from-slate-700 to-slate-600 rounded-lg p-4 shadow-lg">
                    <div>
                        <p class="text-xs text-slate-300 mb-1">Establecimiento Actual</p>
                        <input type="text" id="nombreEstablecimiento"
                            class="text-xl font-bold text-white bg-transparent border-b-2 border-white border-opacity-30 focus:border-opacity-100 outline-none w-full mb-3"
                            placeholder="">
                        <div class="flex items-center gap-2">
                            <p class="text-xs text-slate-300">Fecha:</p>
                            <p id="fechaColecta" class="text-sm font-bold text-white"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botones Ver Anteriores, Compartir, Guardar y Reset -->
            <div class="grid grid-cols-4 gap-2">
                <button id="btnVerAnteriores"
                    class="bg-blue-600 bg-opacity-80 text-white font-semibold py-2 rounded-lg hover:bg-opacity-100 transition-all text-2xl">üìã</button>
                <button id="btnCompartir"
                    class="bg-purple-600 bg-opacity-80 text-white font-semibold py-2 rounded-lg hover:bg-opacity-100 transition-all text-2xl">üì§</button>
                <button id="btnSave"
                    class="bg-gradient-to-r from-green-600 to-emerald-600 text-white font-semibold py-2 rounded-lg hover:from-green-700 hover:to-emerald-700 transition-all text-2xl">üíæ</button>
                <button id="btnReset"
                    class="bg-red-600 bg-opacity-80 text-white font-semibold py-2 rounded-lg hover:bg-opacity-100 transition-all text-2xl">üîÑ</button>
            </div>
        </div>
    </div>

    <!-- Modal Ver Establecimientos Anteriores -->
    <div id="modalEstablecimientos" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="card-glass rounded-2xl p-6 max-w-2xl w-full flex flex-col max-h-[70vh]">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-bold text-white">Establecimientos Guardados</h2>
                <button id="btnCerrarModal" class="text-white hover:text-white text-2xl">‚úï</button>
            </div>

            <!-- Buscador -->
            <div class="mb-4">
                <input type="text" id="buscadorEstablecimientos"
                    class="w-full bg-slate-700 border border-purple-500 border-opacity-30 rounded-lg px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50"
                    placeholder="üîç Buscar establecimiento por nombre...">
                <p id="contadorResultados" class="text-sm text-gray-400 mt-2"></p>
            </div>

            <div id="listaEstablecimientos" class="space-y-3 overflow-y-auto flex-1">
                <!-- Se llenar√° din√°micamente -->
            </div>
        </div>
    </div>

    </div>
    <!-- Fin de colectaPage -->

    <!-- P√°gina de Dashboard -->
    <div id="dashboardPage" class="max-w-6xl mx-auto">
        <!-- Header del Dashboard - Todo en una l√≠nea -->
        <div class="max-w-4xl mx-auto mb-4">
            <div class="card-glass rounded-xl p-3 shadow-xl">
                <div class="flex items-center justify-between">
                    <!-- Izquierda: Empresa y RUC -->
                    <div class="min-w-0">
                        <h3 class="text-base font-bold text-white truncate mb-0.5">LORENS GAMING S.A</h3>
                        <p class="text-xs text-white">RUC: 1813975-1-707784 DV 54</p>
                    </div>

                    <!-- Derecha: Botones (Dashboard activo y Nueva Colecta) -->
                    <div class="flex gap-2">
                        <button onclick="navigateTo('dashboard')"
                                class="nav-tab w-10 h-10 flex items-center justify-center rounded-lg active text-xl"
                                data-page="dashboard"
                                title="Dashboard">
                            üìä
                        </button>
                        <button onclick="navigateTo('colecta')"
                                class="nav-tab w-10 h-10 flex items-center justify-center rounded-lg text-xl"
                                data-page="colecta"
                                title="Nueva Colecta">
                            üìù
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div id="dashboardFilters" class="card-glass rounded-lg p-3 mb-3">
            <label class="text-[10px] text-white mb-2 block">Per√≠odo</label>
            <select id="filtroPeriodo" onchange="cambiarTipoFiltro()" class="w-full bg-slate-700 border border-purple-500 rounded-lg px-2 py-1.5 text-sm text-white focus:outline-none focus:border-purple-400 mb-2">
                <option value="hoy">Hoy</option>
                <option value="ayer">Ayer</option>
                <option value="semana">√öltima semana</option>
                <option value="mes">√öltimo mes</option>
                <option value="personalizado">üìÖ Rango personalizado</option>
            </select>

            <!-- Inputs de fecha personalizada (ocultos por defecto) -->
            <div id="fechasPersonalizadas" class="hidden space-y-2">
                <div>
                    <label class="text-[10px] text-white mb-1 block">Desde</label>
                    <input type="date" id="fechaDesde" onchange="aplicarFiltros()" class="w-full bg-slate-700 border border-purple-500 rounded-lg px-2 py-1.5 text-sm text-white focus:outline-none focus:border-purple-400">
                </div>
                <div>
                    <label class="text-[10px] text-white mb-1 block">Hasta</label>
                    <input type="date" id="fechaHasta" onchange="aplicarFiltros()" class="w-full bg-slate-700 border border-purple-500 rounded-lg px-2 py-1.5 text-sm text-white focus:outline-none focus:border-purple-400">
                </div>
            </div>
        </div>

        <!-- Grid de M√©tricas - 3 columnas en m√≥vil, 4 en tablet/desktop -->
        <div class="grid grid-cols-3 md:grid-cols-4 gap-3 mb-4">
            <!-- Card 1: Ganancia -->
            <div class="card-glass rounded-lg p-3">
                <div class="flex items-center justify-between mb-1">
                    <span class="text-[10px] text-white font-medium">GANANCIA</span>
                    <span class="text-lg">üí∞</span>
                </div>
                <div class="text-base font-bold text-white" id="metricaGanancia">$0.00</div>
                <div class="text-[10px] text-slate-400 mt-1" id="contadorEstablecimientos">0 Colectas</div>
            </div>

            <!-- Card 2: JCJ -->
            <div class="card-glass rounded-lg p-3">
                <div class="flex items-center justify-between mb-1">
                    <span class="text-[10px] text-white font-medium">JCJ</span>
                    <span class="text-lg">üé∞</span>
                </div>
                <div class="text-base font-bold text-cyan-400" id="metricaJCJ">$0.00</div>
            </div>

            <!-- Card 3: 5.5% -->
            <div class="card-glass rounded-lg p-3">
                <div class="flex items-center justify-between mb-1">
                    <span class="text-[10px] text-white font-medium">5.5%</span>
                    <span class="text-lg">üìä</span>
                </div>
                <div class="text-base font-bold text-yellow-400" id="metricaPorcentaje">$0.00</div>
            </div>

            <!-- Card 4: Abonos -->
            <div class="card-glass rounded-lg p-3">
                <div class="flex items-center justify-between mb-1">
                    <span class="text-[10px] text-white font-medium">ABONO</span>
                    <span class="text-lg">üí∏</span>
                </div>
                <div class="text-base font-bold text-green-400" id="metricaTotalAbonos">$0.00</div>
            </div>

            <!-- Card 5: Dep√≥sitos -->
            <div class="card-glass rounded-lg p-3">
                <div class="flex items-center justify-between mb-1">
                    <span class="text-[10px] text-white font-medium">DEP√ìSITO</span>
                    <span class="text-lg">üè¶</span>
                </div>
                <div class="text-base font-bold text-blue-400" id="metricaTotalDepositos">$0.00</div>
            </div>

            <!-- Card 6: Gastos -->
            <div class="card-glass rounded-lg p-3">
                <div class="flex items-center justify-between mb-1">
                    <span class="text-[10px] text-white font-medium">GASTOS</span>
                    <span class="text-lg">üíµ</span>
                </div>
                <div class="text-base font-bold text-red-400" id="metricaTotalGastos">$0.00</div>
            </div>

            <!-- Card 7: Diferencia (DIF%) -->
            <div class="card-glass rounded-lg p-3">
                <div class="flex items-center justify-between mb-1">
                    <span class="text-[10px] text-white font-medium">DIFERENCIA</span>
                    <span class="text-lg">üìâ</span>
                </div>
                <div class="text-base font-bold text-orange-400" id="metricaDiferencia">$0.00</div>
            </div>

            <!-- Card 8: Pendiente -->
            <div class="card-glass rounded-lg p-3">
                <div class="flex items-center justify-between mb-1">
                    <span class="text-[10px] text-white font-medium">PENDIENTE</span>
                    <span class="text-lg">‚è≥</span>
                </div>
                <div class="text-base font-bold text-purple-400" id="metricaPendiente">$0.00</div>
            </div>

            <!-- Card 9: Balance -->
            <div class="card-glass rounded-lg p-3">
                <div class="flex items-center justify-between mb-1">
                    <span class="text-[10px] text-white font-medium">BALANCE</span>
                    <span class="text-lg">üíö</span>
                </div>
                <div class="text-base font-bold text-white" id="metricaBalance">$0.00</div>
            </div>
        </div>

        <!-- Botones de Acci√≥n R√°pida -->
        <div class="card-glass rounded-lg p-3 mb-3">
            <h3 class="text-sm font-bold text-white mb-2">Acciones R√°pidas</h3>
            <div class="grid grid-cols-3 gap-2">
                <button onclick="mostrarModalMovimiento('gasto')"
                        class="bg-gradient-to-br from-red-500 to-red-600 text-white font-bold py-2 px-2 rounded-lg hover:shadow-lg transition-all hover:scale-105 active:scale-95 text-xs">
                    üí∏<br>Gasto
                </button>
                <button onclick="mostrarModalMovimiento('abono')"
                        class="bg-gradient-to-br from-green-500 to-green-600 text-white font-bold py-2 px-2 rounded-lg hover:shadow-lg transition-all hover:scale-105 active:scale-95 text-xs">
                    üí∞<br>Abono
                </button>
                <button onclick="mostrarModalMovimiento('deposito')"
                        class="bg-gradient-to-br from-blue-500 to-blue-600 text-white font-bold py-2 px-2 rounded-lg hover:shadow-lg transition-all hover:scale-105 active:scale-95 text-xs">
                    üè¶<br>Dep√≥sito
                </button>
            </div>
        </div>

        <!-- Lista de Colectas -->
        <div class="card-glass rounded-lg p-3 mb-3">
            <h3 class="text-sm font-bold text-white mb-2">Colectas del Per√≠odo</h3>

            <!-- Filtros de la tarjeta -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-3">
                <div>
                    <label class="text-[10px] text-white mb-1 block">Establecimiento</label>
                    <select id="filtroEstablecimiento" onchange="aplicarFiltros()" class="w-full bg-slate-700 border border-purple-500 rounded-lg px-2 py-1.5 text-sm text-white focus:outline-none focus:border-purple-400">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div>
                    <label class="text-[10px] text-white mb-1 block">Buscar</label>
                    <input type="text" id="filtroBusqueda" oninput="aplicarFiltros()"
                           class="w-full bg-slate-700 border border-purple-500 rounded-lg px-2 py-1.5 text-sm text-white focus:outline-none focus:border-purple-400"
                           placeholder="üîç Buscar...">
                </div>
            </div>

            <!-- Lista scrolleable con altura m√°xima -->
            <div id="listaColectasDashboard" class="space-y-2 overflow-y-auto" style="max-height: 300px;">
                <!-- Se llenar√° din√°micamente -->
            </div>
        </div>

        <!-- Lista de Movimientos -->
        <div class="card-glass rounded-lg p-3">
            <h3 class="text-sm font-bold text-white mb-2">Movimientos Recientes</h3>
            <!-- Lista scrolleable con altura m√°xima -->
            <div id="listaMovimientosDashboard" class="space-y-2 overflow-y-auto" style="max-height: 300px;">
                <!-- Se llenar√° din√°micamente -->
            </div>
        </div>
    </div>
    <!-- Fin de dashboardPage -->

    <!-- Modal de Confirmaci√≥n para Eliminar -->
    <div id="modalConfirmarEliminar" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="card-glass rounded-2xl p-6 max-w-md w-full">
            <div class="text-center">
                <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                <h2 class="text-2xl font-bold text-white mb-2">¬øEliminar Movimiento?</h2>
                <p class="text-slate-300 mb-4" id="confirmacionTexto">
                    Esta acci√≥n no se puede deshacer.
                </p>
                <div class="flex gap-3">
                    <button onclick="cerrarModalConfirmacion()"
                            class="flex-1 px-4 py-3 bg-slate-700 text-white font-bold rounded-lg hover:bg-slate-600 transition-all">
                        ‚ùå Cancelar
                    </button>
                    <button onclick="ejecutarEliminarMovimiento()"
                            class="flex-1 px-4 py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-all">
                        üóëÔ∏è Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n para Resetear -->
    <div id="modalConfirmarReset" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="card-glass rounded-2xl p-6 max-w-md w-full">
            <div class="text-center">
                <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                <h2 class="text-2xl font-bold text-white mb-2">¬øResetear Formulario?</h2>
                <p class="text-slate-300 mb-4">
                    ¬øEst√°s seguro de que quieres limpiar todos los datos del formulario?<br>
                    <span class="text-red-400 font-semibold">Esta acci√≥n no se puede deshacer.</span>
                </p>
                <div class="flex gap-3">
                    <button onclick="cerrarModalReset()"
                            class="flex-1 px-4 py-3 bg-slate-700 text-white font-bold rounded-lg hover:bg-slate-600 transition-all">
                        ‚ùå Cancelar
                    </button>
                    <button onclick="ejecutarResetearFormulario()"
                            class="flex-1 px-4 py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-all">
                        üîÑ Resetear
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n para Guardar -->
    <div id="modalConfirmarGuardar" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="card-glass rounded-2xl p-6 max-w-md w-full">
            <div class="text-center">
                <div class="text-6xl mb-4">üíæ</div>
                <h2 class="text-2xl font-bold text-white mb-2">¬øGuardar Colecta?</h2>

                <!-- Resumen de datos -->
                <div class="bg-slate-800 bg-opacity-50 rounded-lg p-4 mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-slate-300 text-sm">Total Entradas:</span>
                        <span class="text-white font-bold" id="resumenTotalEntradas">$0.00</span>
                    </div>
                    <div class="h-px bg-purple-500 bg-opacity-20"></div>
                    <div class="flex justify-between items-center my-2">
                        <span class="text-slate-300 text-sm">Total Pagos:</span>
                        <span class="text-white font-bold" id="resumenTotalPagos">$0.00</span>
                    </div>
                    <div class="h-px bg-purple-500 bg-opacity-20"></div>
                    <div class="flex justify-between items-center mt-2">
                        <span class="text-white text-sm font-semibold">A Recibir:</span>
                        <span class="text-yellow-400 font-bold text-lg" id="resumenARecibir">$0.00</span>
                    </div>
                </div>

                <p class="text-slate-400 text-xs mb-4">Los datos se enviar√°n a la nube</p>

                <div class="flex gap-3">
                    <button onclick="cerrarModalGuardar()"
                            class="flex-1 px-4 py-3 bg-slate-700 text-white font-bold rounded-lg hover:bg-slate-600 transition-all">
                        ‚ùå Cancelar
                    </button>
                    <button onclick="ejecutarGuardarColecta()"
                            class="flex-1 px-4 py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white font-bold rounded-lg hover:from-green-700 hover:to-emerald-700 transition-all">
                        üíæ Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ver Detalles de Colecta -->
    <div id="modalVerColecta" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="card-glass rounded-2xl p-6 max-w-md w-full">
            <div class="text-center">
                <div class="text-4xl mb-4">üìä</div>
                <h2 class="text-2xl font-bold text-white mb-2" id="tituloEstablecimiento">Establecimiento</h2>
                <p class="text-sm text-slate-400 mb-4" id="fechaEstablecimiento">Fecha</p>

                <!-- Detalles de la colecta -->
                <div class="bg-slate-800 bg-opacity-50 rounded-lg p-4 mb-4 space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-white font-medium">GANANCIA</span>
                        <span class="text-white font-bold text-lg" id="detalleGanancia">$0.00</span>
                    </div>
                    <div class="h-px bg-purple-500 bg-opacity-20"></div>
                    <div class="flex justify-between items-center">
                        <span class="text-white font-medium">JCJ</span>
                        <span class="text-white font-bold text-lg" id="detalleJCJ">$0.00</span>
                    </div>
                    <div class="h-px bg-purple-500 bg-opacity-20"></div>
                    <div class="flex justify-between items-center">
                        <span class="text-white font-medium">5.5%</span>
                        <span class="text-white font-bold text-lg" id="detalle55">$0.00</span>
                    </div>
                    <div class="h-px bg-purple-500 bg-opacity-20"></div>
                    <div class="flex justify-between items-center bg-blue-600 bg-opacity-20 rounded-lg p-2 -mx-2">
                        <span class="text-blue-200 font-bold">A RECIBIR</span>
                        <span class="text-blue-300 font-bold text-xl" id="detalleTotalRecibidoEmpresa">$0.00</span>
                    </div>

                    <!-- Abono (si existe) -->
                    <div id="detalleAbonoContainer" class="hidden">
                        <div class="h-px bg-purple-500 bg-opacity-20"></div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-300 font-medium">ABONO</span>
                            <span class="text-green-400 font-bold text-lg" id="detalleAbono">$0.00</span>
                        </div>
                    </div>

                    <!-- DIF% (si existe) -->
                    <div id="detalleDifContainer" class="hidden">
                        <div class="h-px bg-purple-500 bg-opacity-20"></div>
                        <div class="flex justify-between items-center">
                            <span class="text-yellow-300 font-medium">DIF%</span>
                            <span class="text-yellow-400 font-bold text-lg" id="detalleDif">$0.00</span>
                        </div>
                    </div>

                    <!-- DEP√ìSITO (si existe) -->
                    <div id="detalleDepositoContainer" class="hidden">
                        <div class="h-px bg-purple-500 bg-opacity-20"></div>
                        <div class="flex justify-between items-center">
                            <span class="text-blue-300 font-medium">DEP√ìSITO</span>
                            <span class="text-blue-400 font-bold text-lg" id="detalleDeposito">$0.00</span>
                        </div>
                    </div>

                    <!-- PENDIENTE (si existe) -->
                    <div id="detallePendienteContainer" class="hidden">
                        <div class="h-px bg-purple-500 bg-opacity-20"></div>
                        <div class="flex justify-between items-center">
                            <span class="text-orange-300 font-medium">PENDIENTE</span>
                            <span class="text-orange-400 font-bold text-lg" id="detallePendiente">$0.00</span>
                        </div>
                    </div>

                    <div class="h-px bg-purple-500 bg-opacity-20"></div>
                    <div class="flex justify-between items-center bg-purple-600 bg-opacity-30 rounded-lg p-2 -mx-2">
                        <span class="text-white font-bold">TOTAL RECIBIDO</span>
                        <span class="text-white font-bold text-xl" id="detalleTotalRecibido">$0.00</span>
                    </div>
                </div>

                <button onclick="cerrarModalVerColecta()"
                        class="w-full px-4 py-3 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition-all">
                    ‚úì Cerrar
                </button>
            </div>
        </div>
    </div>

    <script>

        // ========== SISTEMA DE NOTIFICACIONES ==========

        function showNotification({
            title = 'Notificaci√≥n',
            message = '',
            type = 'info',
            duration = 5000,
            icon = null
        } = {}) {

            // Crear contenedor si no existe
            let container = document.getElementById('notification-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'notification-container';
                container.className = 'notification-container';
                document.body.appendChild(container);
            }

            // Mapear tipos a iconos
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };

            const notificationIcon = icon || icons[type] || icons.info;

            // Crear la notificaci√≥n
            const notificationId = 'notification-' + Date.now();
            const notificationHTML = `
        <div id="${notificationId}" class="notification notification-${type}">
            <button class="notification-close" onclick="removeNotification('${notificationId}')">√ó</button>
            <div class="notification-content">
                <div class="notification-icon">${notificationIcon}</div>
                <div class="notification-text">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
            </div>
            <div class="notification-progress">
                <div class="notification-progress-bar" style="animation: progress ${duration}ms linear forwards;"></div>
            </div>
        </div>
    `;

            // Agregar al contenedor
            container.insertAdjacentHTML('afterbegin', notificationHTML);

            // Mostrar con animaci√≥n
            setTimeout(() => {
                const notification = document.getElementById(notificationId);
                if (notification) {
                    notification.classList.add('show');
                }
            }, 10);

            // Auto-remover despu√©s de la duraci√≥n
            if (duration > 0) {
                setTimeout(() => {
                    removeNotification(notificationId);
                }, duration);
            }

            return notificationId;
        }

        // Funci√≥n para remover notificaci√≥n
        function removeNotification(id) {
            const notification = document.getElementById(id);
            if (notification) {
                notification.classList.remove('show');
                notification.classList.add('hide');

                setTimeout(() => {
                    if (notification && notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }
        }

        // Funci√≥n para notificaci√≥n de √©xito
        function showSuccess(message, title = '¬°√âxito!') {
            return showNotification({
                title: title,
                message: message,
                type: 'success',
                duration: 4000
            });
        }

        // Funci√≥n para notificaci√≥n de error
        function showError(message, title = 'Error') {
            return showNotification({
                title: title,
                message: message,
                type: 'error',
                duration: 5000
            });
        }

        // Funci√≥n para notificaci√≥n de advertencia
        function showWarning(message, title = 'Advertencia') {
            return showNotification({
                title: title,
                message: message,
                type: 'warning',
                duration: 4500
            });
        }

        // Funci√≥n para notificaci√≥n de informaci√≥n
        function showInfo(message, title = 'Informaci√≥n') {
            return showNotification({
                title: title,
                message: message,
                type: 'info',
                duration: 3500
            });
        }

        // Agregar animaci√≥n de progreso al CSS
        const style = document.createElement('style');
        style.textContent = `
    @keyframes progress {
        from { transform: scaleX(1); }
        to { transform: scaleX(0); }
    }
`;
        document.head.appendChild(style);

        // ========== DASHBOARD - ESTADO Y NAVEGACI√ìN ==========

        const dashboardState = {
            currentPage: 'dashboard',
            filters: {
                periodo: 'hoy',
                fechaInicio: null,
                fechaFin: null,
                establecimiento: null,
                busqueda: ''
            },
            metricas: null,
            colectas: [],
            movimientos: []
        };

        // Funci√≥n de navegaci√≥n entre p√°ginas
        function navigateTo(page) {
            const currentEl = document.getElementById(`${dashboardState.currentPage}Page`);
            const newEl = document.getElementById(`${page}Page`);

            if (!currentEl || !newEl) {
                console.error('Error: No se encontraron las p√°ginas', page, dashboardState.currentPage);
                return;
            }

            // Si ya estamos en la p√°gina solicitada, solo recargar dashboard si es el caso
            if (page === dashboardState.currentPage) {
                if (page === 'dashboard') {
                    cargarDashboard();
                }
                return;
            }

            currentEl.classList.add('fade-out');

            setTimeout(() => {
                currentEl.classList.add('hidden');
                currentEl.classList.remove('fade-out');

                newEl.classList.remove('hidden');
                newEl.classList.add('fade-in');

                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.page === page);
                });

                dashboardState.currentPage = page;

                if (page === 'dashboard') {
                    cargarDashboard();
                }
            }, 200);
        }

        // Funci√≥n para obtener fechas seg√∫n filtro de per√≠odo
        function obtenerFechasFiltro() {
            const hoy = new Date();
            let fechaInicio, fechaFin;

            switch (dashboardState.filters.periodo) {
                case 'hoy':
                    fechaInicio = fechaFin = formatDateSQL(hoy);
                    break;
                case 'ayer':
                    const ayer = new Date(hoy);
                    ayer.setDate(ayer.getDate() - 1);
                    fechaInicio = fechaFin = formatDateSQL(ayer);
                    break;
                case 'semana':
                    const semanaAtras = new Date(hoy);
                    semanaAtras.setDate(semanaAtras.getDate() - 7);
                    fechaInicio = formatDateSQL(semanaAtras);
                    fechaFin = formatDateSQL(hoy);
                    break;
                case 'mes':
                    const mesAtras = new Date(hoy);
                    mesAtras.setMonth(mesAtras.getMonth() - 1);
                    fechaInicio = formatDateSQL(mesAtras);
                    fechaFin = formatDateSQL(hoy);
                    break;
                case 'personalizado':
                    // Obtener fechas de los inputs
                    const fechaDesdeInput = document.getElementById('fechaDesde').value;
                    const fechaHastaInput = document.getElementById('fechaHasta').value;

                    if (fechaDesdeInput && fechaHastaInput) {
                        fechaInicio = fechaDesdeInput;
                        fechaFin = fechaHastaInput;
                    } else {
                        // Si no hay fechas seleccionadas, usar hoy
                        fechaInicio = fechaFin = formatDateSQL(hoy);
                    }
                    break;
                default:
                    fechaInicio = fechaFin = formatDateSQL(hoy);
            }

            return { fechaInicio, fechaFin };
        }

        // Funci√≥n para mostrar/ocultar inputs de fecha personalizada
        function cambiarTipoFiltro() {
            const periodo = document.getElementById('filtroPeriodo').value;
            const contenedorFechas = document.getElementById('fechasPersonalizadas');

            if (periodo === 'personalizado') {
                contenedorFechas.classList.remove('hidden');

                // Establecer fecha de hoy en los inputs si est√°n vac√≠os
                const hoy = formatDateSQL(new Date());
                const fechaDesdeInput = document.getElementById('fechaDesde');
                const fechaHastaInput = document.getElementById('fechaHasta');

                if (!fechaDesdeInput.value) {
                    fechaDesdeInput.value = hoy;
                }
                if (!fechaHastaInput.value) {
                    fechaHastaInput.value = hoy;
                }
            } else {
                contenedorFechas.classList.add('hidden');
            }

            aplicarFiltros();
        }

        // Formatear fecha a formato SQL (YYYY-MM-DD)
        function formatDateSQL(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Formatear moneda
        function formatCurrency(value) {
            return '$' + Number(value || 0).toFixed(2);
        }

        // Cargar dashboard completo
        async function cargarDashboard() {
            console.log('=== Cargando Dashboard ===');
            try {
                const { fechaInicio, fechaFin } = obtenerFechasFiltro();
                console.log('Fechas:', fechaInicio, 'a', fechaFin);

                await cargarFiltroEstablecimientos();
                await cargarMetricas(fechaInicio, fechaFin);
                await cargarListaColectas(fechaInicio, fechaFin);
                await cargarMovimientosRecientes(fechaInicio, fechaFin);

                console.log('=== Dashboard cargado exitosamente ===');
            } catch (error) {
                console.error('Error al cargar dashboard:', error);
                showError('Error al cargar dashboard: ' + error.message);
            }
        }

        // Cargar opciones del selector de establecimientos
        async function cargarFiltroEstablecimientos() {
            console.log('Cargando filtro de establecimientos...');
            if (typeof Android === 'undefined') return;

            try {
                const establecimientosJSON = Android.obtenerEstablecimientos();
                const establecimientos = JSON.parse(establecimientosJSON);

                const selectEl = document.getElementById('filtroEstablecimiento');
                if (!selectEl) {
                    console.warn('Elemento filtroEstablecimiento no encontrado');
                    return;
                }

                // Guardar el valor actualmente seleccionado
                const valorActual = dashboardState.filters.establecimiento || '';

                // Obtener establecimientos √∫nicos por nombre
                const establecimientosUnicos = {};
                establecimientos.forEach(est => {
                    if (!establecimientosUnicos[est.nombre]) {
                        establecimientosUnicos[est.nombre] = est.id;
                    }
                });

                // Construir opciones
                let optionsHTML = '<option value="">Todos</option>';
                Object.keys(establecimientosUnicos).forEach(nombre => {
                    const selected = nombre === valorActual ? 'selected' : '';
                    optionsHTML += `<option value="${nombre}" ${selected}>${nombre}</option>`;
                });

                selectEl.innerHTML = optionsHTML;
                console.log(`‚úì Filtro cargado con ${Object.keys(establecimientosUnicos).length} establecimientos`);
                console.log(`  Valor seleccionado: "${valorActual}"`);

            } catch (error) {
                console.error('Error al cargar filtro de establecimientos:', error);
            }
        }

        // Cargar m√©tricas del dashboard
        async function cargarMetricas(fechaInicio, fechaFin) {
            console.log('Cargando m√©tricas...');
            if (typeof Android === 'undefined') {
                console.warn('Android interface no disponible');
                return;
            }

            try {
                // Obtener m√©tricas de movimientos (gastos desde tabla movimientos)
                const metricasJSON = fechaInicio === fechaFin
                    ? Android.obtenerMetricasDashboard(fechaInicio)
                    : Android.obtenerMetricasRango(fechaInicio, fechaFin);

                console.log('M√©tricas JSON recibidas:', metricasJSON);
                const metricas = JSON.parse(metricasJSON);
                console.log('M√©tricas parseadas:', metricas);

                // Obtener establecimientos para sumar valores de las colectas
                const establecimientosJSON = Android.obtenerEstablecimientos();
                const establecimientos = JSON.parse(establecimientosJSON);

                // Filtrar establecimientos por rango de fechas
                const establecimientosFiltrados = establecimientos.filter(est => {
                    return est.fecha >= fechaInicio && est.fecha <= fechaFin;
                });

                // Sumar valores de las colectas
                let totalARecibir = 0;
                let totalGananciaCU = 0;
                let totalImpuestoJCJ = 0;
                let totalRetencion55 = 0;
                let totalAbonosColectas = 0;
                let totalDepositosColectas = 0;
                let totalDiferenciaColectas = 0;
                let totalPendienteColectas = 0;

                establecimientosFiltrados.forEach(est => {
                    const totales = est.datos?.totales || {};

                    // Sumar A RECIBIR directamente (fuente de verdad para BALANCE)
                    const aRecibir = parseFloat(totales.aRecibir) || 0;
                    totalARecibir += aRecibir;

                    // Sumar Ganancia C/U
                    const gananciaCU = parseFloat(totales.gananciaCU) || 0;
                    totalGananciaCU += gananciaCU;

                    // Sumar Impuesto JCJ
                    const impuestoJCJ = parseFloat(totales.impuestoJCJ) || 0;
                    totalImpuestoJCJ += impuestoJCJ;

                    // Sumar Retenci√≥n 5.5%
                    const retencion55 = parseFloat(totales.retencion55) || 0;
                    totalRetencion55 += retencion55;

                    // Sumar Abonos de colectas
                    const abono = parseFloat(totales.abono) || 0;
                    totalAbonosColectas += abono;

                    // Sumar Dep√≥sitos de colectas
                    const deposito = parseFloat(totales.deposito) || 0;
                    totalDepositosColectas += deposito;

                    // Sumar Diferencia (DIF%)
                    const diferencia = parseFloat(totales.difPorcentaje) || 0;
                    totalDiferenciaColectas += diferencia;

                    // Sumar Pendiente de colectas
                    const pendiente = parseFloat(totales.pendiente) || 0;
                    totalPendienteColectas += pendiente;
                });

                console.log('Totales de colectas:', {
                    aRecibir: totalARecibir,
                    gananciaCU: totalGananciaCU,
                    impuestoJCJ: totalImpuestoJCJ,
                    retencion55: totalRetencion55,
                    abonos: totalAbonosColectas,
                    depositos: totalDepositosColectas,
                    diferencia: totalDiferenciaColectas,
                    pendiente: totalPendienteColectas
                });

                // Sumar movimientos de acciones r√°pidas
                const totalAbonosMovimientos = metricas.totalAbonos || 0;
                const totalDepositosMovimientos = metricas.totalDepositos || 0;
                const totalGastosMovimientos = metricas.totalGastos || 0;

                // Totales combinados
                const totalAbonos = totalAbonosColectas + totalAbonosMovimientos;
                const totalDepositos = totalDepositosColectas + totalDepositosMovimientos;

                // BALANCE = suma de A RECIBIR + ABONOS - GASTOS - DEP√ìSITOS (efectivo real al final del d√≠a)
                const balance = totalARecibir + totalAbonosMovimientos - totalGastosMovimientos - totalDepositosMovimientos;

                // Actualizar UI - Las 9 tarjetas
                document.getElementById('metricaGanancia').textContent = formatCurrency(totalGananciaCU);
                document.getElementById('metricaJCJ').textContent = formatCurrency(totalImpuestoJCJ);
                document.getElementById('metricaPorcentaje').textContent = formatCurrency(totalRetencion55);
                document.getElementById('metricaTotalAbonos').textContent = formatCurrency(totalAbonos);
                document.getElementById('metricaTotalDepositos').textContent = formatCurrency(totalDepositos);
                document.getElementById('metricaTotalGastos').textContent = formatCurrency(totalGastosMovimientos);
                document.getElementById('metricaDiferencia').textContent = formatCurrency(totalDiferenciaColectas);
                document.getElementById('metricaPendiente').textContent = formatCurrency(totalPendienteColectas);

                // Actualizar contador de colectas
                const contadorEl = document.getElementById('contadorEstablecimientos');
                if (contadorEl) {
                    const cantidad = establecimientosFiltrados.length;
                    contadorEl.textContent = `${cantidad} Colecta${cantidad !== 1 ? 's' : ''}`;
                }

                const balanceEl = document.getElementById('metricaBalance');
                balanceEl.textContent = formatCurrency(balance);
                balanceEl.classList.remove('text-red-400', 'text-green-400', 'text-white');
                balanceEl.classList.add(balance < 0 ? 'text-red-400' : balance > 0 ? 'text-green-400' : 'text-white');

                console.log('Balance calculado:', {
                    gananciaCU: totalGananciaCU,
                    impuestoJCJ: totalImpuestoJCJ,
                    retencion55: totalRetencion55,
                    abonos: totalAbonos,
                    depositos: totalDepositos,
                    gastos: totalGastosMovimientos,
                    diferencia: totalDiferenciaColectas,
                    balance: balance
                });

                dashboardState.metricas = metricas;

            } catch (error) {
                console.error('Error al cargar m√©tricas:', error);
            }
        }

        // Cargar lista de colectas
        async function cargarListaColectas(fechaInicio, fechaFin) {
            console.log('Cargando lista de colectas...');
            if (typeof Android === 'undefined') return;

            try {
                const establecimientosJSON = Android.obtenerEstablecimientos();
                console.log('Establecimientos JSON:', establecimientosJSON);
                const establecimientos = JSON.parse(establecimientosJSON);
                console.log('Total establecimientos:', establecimientos.length);

                // Obtener filtros
                const filtroEstablecimiento = dashboardState.filters.establecimiento || '';
                const filtroBusqueda = (dashboardState.filters.busqueda || '').toLowerCase().trim();

                // Filtrar por fecha, establecimiento y b√∫squeda
                const colectasFiltradas = establecimientos.filter(est => {
                    console.log(`Evaluando colecta: "${est.nombre}", fecha="${est.fecha}"`);
                    console.log(`  Comparando con rango: ${fechaInicio} <= ${est.fecha} <= ${fechaFin}`);

                    // Filtro por fecha
                    let cumpleFecha = true;
                    if (fechaInicio && fechaFin) {
                        cumpleFecha = est.fecha >= fechaInicio && est.fecha <= fechaFin;
                        console.log(`  Cumple fecha: ${cumpleFecha}`);
                    }

                    // Filtro por establecimiento (solo si NO es "Todos" o vac√≠o)
                    let cumpleEstablecimiento = true;
                    if (filtroEstablecimiento && filtroEstablecimiento !== '') {
                        cumpleEstablecimiento = est.nombre === filtroEstablecimiento;
                        console.log(`  Cumple establecimiento (${filtroEstablecimiento}): ${cumpleEstablecimiento}`);
                    }

                    // Filtro por b√∫squeda (busca en nombre del establecimiento)
                    let cumpleBusqueda = true;
                    if (filtroBusqueda) {
                        const nombreLower = est.nombre.toLowerCase();
                        cumpleBusqueda = nombreLower.includes(filtroBusqueda);
                        console.log(`  Cumple b√∫squeda ("${filtroBusqueda}"): ${cumpleBusqueda}`);
                    }

                    const cumple = cumpleFecha && cumpleEstablecimiento && cumpleBusqueda;
                    console.log(`  Resultado final: ${cumple}`);
                    return cumple;
                });

                console.log('Colectas filtradas:', colectasFiltradas.length);
                dashboardState.colectas = colectasFiltradas;

                const listaEl = document.getElementById('listaColectasDashboard');
                if (colectasFiltradas.length === 0) {
                    listaEl.innerHTML = '<p class="text-slate-400 text-sm text-center py-4">No hay colectas en este per√≠odo</p>';
                    return;
                }

                listaEl.innerHTML = colectasFiltradas.map(est => {
                    // 'datos' ya viene parseado como objeto desde Android
                    const datos = est.datos;
                    const aRecibir = datos.totales?.aRecibir || '0';
                    const fechaVisual = formatDateForDisplay(est.fecha);
                    return `
                        <div class="bg-slate-800 bg-opacity-50 rounded-lg p-3 border border-purple-500 border-opacity-20 hover:border-opacity-40 transition-all">
                            <div class="flex justify-between items-center">
                                <div class="flex-1">
                                    <h4 class="text-white font-bold text-sm">${est.nombre}</h4>
                                    <p class="text-xs text-slate-400">${fechaVisual}</p>
                                </div>
                                <div class="text-right mr-3">
                                    <p class="text-white font-bold text-lg">${aRecibir}</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="verColecta(${est.id})"
                                            class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-all">
                                        Ver
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error al cargar colectas:', error);
            }
        }

        // Cargar movimientos recientes
        async function cargarMovimientosRecientes(fechaInicio, fechaFin) {
            if (typeof Android === 'undefined') return;

            try {
                const movimientosJSON = Android.obtenerMovimientos(fechaInicio, null);
                const movimientos = JSON.parse(movimientosJSON);

                dashboardState.movimientos = movimientos;

                const listaEl = document.getElementById('listaMovimientosDashboard');
                if (movimientos.length === 0) {
                    listaEl.innerHTML = '<p class="text-slate-400 text-sm text-center py-4">No hay movimientos registrados</p>';
                    return;
                }

                const iconos = {
                    'gasto': 'üí∏',
                    'abono': 'üí∞',
                    'deposito': 'üè¶'
                };

                const colores = {
                    'gasto': 'text-red-400',
                    'abono': 'text-green-400',
                    'deposito': 'text-blue-400'
                };

                listaEl.innerHTML = movimientos.slice(0, 20).map(mov => {
                    console.log('Movimiento para renderizar:', mov);
                    console.log('ID del movimiento:', mov.id);
                    const hora = new Date(mov.fecha_hora).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                    return `
                        <div class="bg-slate-800 bg-opacity-50 rounded-lg p-3 border border-purple-500 border-opacity-20">
                            <div class="flex justify-between items-center gap-2">
                                <div class="flex items-center gap-2 flex-1">
                                    <span class="text-xl">${iconos[mov.tipo] || 'üìù'}</span>
                                    <div class="flex-1">
                                        <p class="text-white font-medium text-sm">${mov.tipo.toUpperCase()}</p>
                                        <p class="text-xs text-slate-400">${mov.descripcion || 'Sin descripci√≥n'}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="${colores[mov.tipo] || 'text-white'} font-bold">${formatCurrency(mov.monto)}</p>
                                    <p class="text-xs text-slate-400">${hora}</p>
                                </div>
                                <button onclick="confirmarEliminarMovimiento(${mov.id}, '${mov.tipo}', ${mov.monto})"
                                        class="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700 transition-all flex-shrink-0">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error al cargar movimientos:', error);
            }
        }

        // Variable global para almacenar el ID del movimiento a eliminar
        let movimientoAEliminar = null;

        // Mostrar modal de confirmaci√≥n
        function confirmarEliminarMovimiento(id, tipo, monto) {
            console.log('confirmarEliminarMovimiento llamado con:', { id, tipo, monto });
            console.log('Tipo de id:', typeof id);
            movimientoAEliminar = id;
            console.log('movimientoAEliminar asignado:', movimientoAEliminar);

            const tipoTexto = tipo.charAt(0).toUpperCase() + tipo.slice(1);
            const montoTexto = formatCurrency(monto);

            const modal = document.getElementById('modalConfirmarEliminar');
            const textoEl = document.getElementById('confirmacionTexto');

            textoEl.innerHTML = `
                <div class="bg-slate-800 bg-opacity-50 rounded-lg p-3 mb-3">
                    <p class="text-sm text-slate-400">Tipo:</p>
                    <p class="text-lg font-bold text-white">${tipoTexto}</p>
                    <p class="text-sm text-slate-400 mt-2">Monto:</p>
                    <p class="text-lg font-bold text-white">${montoTexto}</p>
                </div>
                <p class="text-slate-300 text-sm">Esta acci√≥n no se puede deshacer.</p>
            `;

            modal.classList.remove('hidden');
        }

        // Cerrar modal de confirmaci√≥n
        function cerrarModalConfirmacion() {
            const modal = document.getElementById('modalConfirmarEliminar');
            modal.classList.add('hidden');
            movimientoAEliminar = null;
        }

        // Ejecutar eliminaci√≥n del movimiento
        function ejecutarEliminarMovimiento() {
            if (movimientoAEliminar === null) {
                return;
            }

            // Guardar el ID antes de cerrar el modal (que resetea la variable)
            const idAEliminar = movimientoAEliminar;

            cerrarModalConfirmacion();

            if (typeof Android === 'undefined') {
                showError('Esta funci√≥n solo est√° disponible en la aplicaci√≥n Android', '‚ö†Ô∏è No Disponible');
                return;
            }

            try {
                console.log(`Eliminando movimiento ID: ${idAEliminar}`);
                const resultadoJSON = Android.eliminarMovimiento(idAEliminar);

                console.log(`Resultado de eliminaci√≥n (JSON): ${resultadoJSON}`);

                // Android.eliminarMovimiento retorna un String JSON
                const resultado = JSON.parse(resultadoJSON);

                if (resultado.success) {
                    showSuccess('Movimiento eliminado exitosamente', '‚úÖ Eliminado');

                    // Recargar dashboard para actualizar las m√©tricas y la lista
                    setTimeout(() => {
                        cargarDashboard();
                    }, 500);
                } else {
                    showError(resultado.message || 'No se pudo eliminar el movimiento', '‚ùå Error');
                }
            } catch (error) {
                console.error('Error al eliminar movimiento:', error);
                showError('Error al eliminar: ' + error.message, '‚ùå Error');
            }

            movimientoAEliminar = null;
        }

        // Aplicar filtros del dashboard
        function aplicarFiltros() {
            dashboardState.filters.periodo = document.getElementById('filtroPeriodo').value;
            dashboardState.filters.establecimiento = document.getElementById('filtroEstablecimiento').value;
            dashboardState.filters.busqueda = document.getElementById('filtroBusqueda').value;

            console.log('=== Filtros aplicados ===');
            console.log('  Per√≠odo:', dashboardState.filters.periodo);
            console.log('  Establecimiento:', dashboardState.filters.establecimiento || '(Todos)');
            console.log('  B√∫squeda:', dashboardState.filters.busqueda || '(vac√≠o)');

            cargarDashboard();
        }

        // Ver colecta desde el dashboard
        function verColecta(id) {
            if (typeof Android === 'undefined') {
                showError('Esta funci√≥n solo est√° disponible en la aplicaci√≥n Android', '‚ö†Ô∏è No Disponible');
                return;
            }

            try {
                const establecimientoJSON = Android.obtenerEstablecimiento(id);
                const establecimiento = JSON.parse(establecimientoJSON);

                if (!establecimiento || !establecimiento.datos || !establecimiento.datos.totales) {
                    showError('No se pudieron cargar los detalles de la colecta', '‚ùå Error');
                    return;
                }

                // Extraer los datos
                const totales = establecimiento.datos.totales;
                const ganancia = parseFloat(totales.gananciaCU) || 0;
                const jcj = parseFloat(totales.impuestoJCJ) || 0;
                const retencion55 = parseFloat(totales.retencion55) || 0;
                const abono = parseFloat(totales.abono) || 0;
                const difPorcentaje = parseFloat(totales.difPorcentaje) || 0;
                const deposito = parseFloat(totales.deposito) || 0;
                const pendiente = parseFloat(totales.pendiente) || 0;

                // Calcular totales
                const totalRecibidoEmpresa = ganancia + jcj + retencion55;
                const totalRecibido = totalRecibidoEmpresa + abono - difPorcentaje - deposito - pendiente;

                // Actualizar el modal con los datos b√°sicos
                document.getElementById('tituloEstablecimiento').textContent = establecimiento.nombre;
                document.getElementById('fechaEstablecimiento').textContent = formatDateForDisplay(establecimiento.fecha);
                document.getElementById('detalleGanancia').textContent = formatCurrency(ganancia);
                document.getElementById('detalleJCJ').textContent = formatCurrency(jcj);
                document.getElementById('detalle55').textContent = formatCurrency(retencion55);
                document.getElementById('detalleTotalRecibidoEmpresa').textContent = formatCurrency(totalRecibidoEmpresa);

                // Mostrar/ocultar y actualizar ABONO (solo si existe)
                const abonoContainer = document.getElementById('detalleAbonoContainer');
                if (abono > 0) {
                    document.getElementById('detalleAbono').textContent = formatCurrency(abono);
                    abonoContainer.classList.remove('hidden');
                } else {
                    abonoContainer.classList.add('hidden');
                }

                // Mostrar/ocultar y actualizar DIF% (solo si existe)
                const difContainer = document.getElementById('detalleDifContainer');
                if (difPorcentaje > 0) {
                    document.getElementById('detalleDif').textContent = formatCurrency(difPorcentaje);
                    difContainer.classList.remove('hidden');
                } else {
                    difContainer.classList.add('hidden');
                }

                // Mostrar/ocultar y actualizar DEP√ìSITO (solo si existe)
                const depositoContainer = document.getElementById('detalleDepositoContainer');
                if (deposito > 0) {
                    document.getElementById('detalleDeposito').textContent = formatCurrency(deposito);
                    depositoContainer.classList.remove('hidden');
                } else {
                    depositoContainer.classList.add('hidden');
                }

                // Mostrar/ocultar y actualizar PENDIENTE (solo si existe)
                const pendienteContainer = document.getElementById('detallePendienteContainer');
                if (pendiente > 0) {
                    document.getElementById('detallePendiente').textContent = formatCurrency(pendiente);
                    pendienteContainer.classList.remove('hidden');
                } else {
                    pendienteContainer.classList.add('hidden');
                }

                // Actualizar total recibido final
                document.getElementById('detalleTotalRecibido').textContent = formatCurrency(totalRecibido);

                // Mostrar el modal
                document.getElementById('modalVerColecta').classList.remove('hidden');
            } catch (error) {
                console.error('Error al cargar colecta:', error);
                showError('Error al cargar la colecta: ' + error.message, '‚ùå Error');
            }
        }

        // Cerrar modal de ver colecta
        function cerrarModalVerColecta() {
            document.getElementById('modalVerColecta').classList.add('hidden');
        }

        // Mostrar modal para registrar movimiento
        function mostrarModalMovimiento(tipo) {
            // Si el modal no existe, crearlo primero
            if (!document.getElementById('gastosModal')) {
                showGastosModal();
            }

            // Esperar un momento para que el modal se cree y luego seleccionar autom√°ticamente el tipo
            setTimeout(() => {
                const boton = document.querySelector(`[data-tipo="${tipo}"]`);
                if (boton) {
                    boton.click();
                }
            }, 100);
        }

        // Funci√≥n para obtener fecha actual formateada (solo fecha)
        function getCurrentDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateForDisplay(dateStr) {
            // Convierte "2026-01-26" a "26 ene 2026"
            const [year, month, day] = dateStr.split('-');
            const date = new Date(year, parseInt(month) - 1, day);
            const options = {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            };
            return date.toLocaleDateString('es-ES', options);
        }

        // Variables globales - SOLO UNA VEZ
        let machineCount = 0;
        let machines = [];
        // ========== NUEVO SISTEMA MAS CORREGIDO ==========

        // Variables para controlar el estado del bot√≥n MAS
        let masTodasVisible = false;
        let opcionesSeleccionadas = [];

        // Funci√≥n para mostrar/ocultar TODAS las opciones
        function toggleTodasOpcionesMAS() {
            const masTodas = document.getElementById('masTodasOpciones');
            const masArrow = document.getElementById('masArrow');

            masTodasVisible = !masTodasVisible;

            if (masTodasVisible) {
                masTodas.classList.remove('hidden');
                masArrow.style.transform = 'rotate(180deg)';
            } else {
                masTodas.classList.add('hidden');
                masArrow.style.transform = 'rotate(0deg)';
            }
        }


        // ========== GENERAR IMAGEN PARA COMPARTIR ==========

        function generarImagenParaCompartir() {
            showNotification({
                title: 'Generando imagen',
                message: 'Por favor espera...',
                type: 'info',
                duration: 2000
            });

            setTimeout(() => {
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    if (!ctx) {
                        throw new Error('No se pudo obtener contexto 2D del canvas');
                    }

                    // Calcular altura necesaria basada en las m√°quinas y opciones adicionales
                    const numMaquinas = machines.filter(m => document.getElementById('mw-' + m.index)).length;
                    const alturaPorMaquina = 620; // Altura aproximada por cada m√°quina (aumentado para ganancia y % pago)

                    // Calcular altura para opciones adicionales (bot√≥n m√°s) usando el array opcionesSeleccionadas
                    let alturaOpciones = 0;
                    if (opcionesSeleccionadas.length > 0) {
                        alturaOpciones = 100; // Base de la card
                        alturaOpciones += (opcionesSeleccionadas.length * 60); // 60px por cada opci√≥n
                        alturaOpciones += 40; // Espacio despu√©s de la card
                    }

                    // Calcular altura para observaciones y estado
                    let alturaObservacionesEstado = 0;
                    const observaciones = document.getElementById('observaciones')?.value.trim() || '';
                    const estado = document.getElementById('estado')?.value.trim() || '';
                    if (observaciones || estado) {
                        alturaObservacionesEstado = 80; // Base de la card
                        if (observaciones) {
                            const lineasObservaciones = Math.ceil(observaciones.length / 60) || 1;
                            alturaObservacionesEstado += 60 + (lineasObservaciones * 35);
                        }
                        if (estado) {
                            alturaObservacionesEstado += 60;
                        }
                        alturaObservacionesEstado += 40; // Espacio despu√©s de la card
                    }

                    const alturaBase = 1800; // Encabezado + resumen + footer
                    const alturaTotal = alturaBase + (numMaquinas * 740) + alturaOpciones + alturaObservacionesEstado; // 740 = 700 (cardHeight) + 30 (espacio entre cards) + 10 (margen extra)

                    // Ancho de celular (1080px)
                    canvas.width = 1080;
                    canvas.height = alturaTotal;

                    let y = 0;
                    const padding = 30;
                    const cardPadding = 40;

                    // Fondo blanco
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    // Funci√≥n auxiliar para dibujar tarjeta con borde redondeado
                    function dibujarCard(x, y, width, height, bgColor = '#F8FAFC', borderColor = '#8B5CF6', borderWidth = 2) {
                        const radius = 16;
                        ctx.fillStyle = bgColor;
                        ctx.strokeStyle = borderColor;
                        ctx.lineWidth = borderWidth;

                        ctx.beginPath();
                        ctx.moveTo(x + radius, y);
                        ctx.lineTo(x + width - radius, y);
                        ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
                        ctx.lineTo(x + width, y + height - radius);
                        ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
                        ctx.lineTo(x + radius, y + height);
                        ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
                        ctx.lineTo(x, y + radius);
                        ctx.quadraticCurveTo(x, y, x + radius, y);
                        ctx.closePath();
                        ctx.fill();
                        ctx.stroke();
                    }

                    // ========== ENCABEZADO ==========
                    y += padding + 40;

                    ctx.fillStyle = '#000000';
                    ctx.font = 'bold 48px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('LORENS GAMING S.A', canvas.width / 2, y);
                    y += 50;

                    ctx.font = '28px Arial';
                    ctx.fillStyle = '#64748B';
                    ctx.fillText('RUC: 1813975-1-707784 DV 54', canvas.width / 2, y);
                    y += 40;
                    ctx.fillText('Sistema de Colecta - v1.0', canvas.width / 2, y);
                    y += 50;

                    // ========== ESTABLECIMIENTO Y FECHA ==========
                    const nombreEst = document.getElementById('nombreEstablecimiento').value || 'Sin nombre';
                    const fecha = document.getElementById('fechaColecta').textContent; // Para PDF usar formato visual

                    const cardEstY = y;
                    const cardEstHeight = 140;
                    dibujarCard(padding, cardEstY, canvas.width - (padding * 2), cardEstHeight, '#F3E8FF', '#8B5CF6', 3);

                    y += 50;
                    ctx.fillStyle = '#6B21A8';
                    ctx.font = '24px Arial';
                    ctx.textAlign = 'left';
                    ctx.fillText('Establecimiento Actual', padding + cardPadding, y);
                    y += 45;

                    ctx.fillStyle = '#000000';
                    ctx.font = 'bold 40px Arial';
                    ctx.fillText(nombreEst, padding + cardPadding, y);

                    // Fecha en la derecha
                    ctx.textAlign = 'right';
                    ctx.fillStyle = '#6B21A8';
                    ctx.font = '24px Arial';
                    ctx.fillText('Fecha', canvas.width - padding - cardPadding, cardEstY + 50);
                    ctx.fillStyle = '#000000';
                    ctx.font = 'bold 32px Arial';
                    ctx.fillText(fecha, canvas.width - padding - cardPadding, cardEstY + 95);

                    y = cardEstY + cardEstHeight + 40;

                    // ========== M√ÅQUINAS ==========
                    for (let i = 0; i < machines.length; i++) {
                        const m = machines[i];
                        const idx = m.index;

                        if (!document.getElementById('mw-' + idx)) continue;

                        const juego = document.getElementById('juego-' + idx)?.value || 'Sin nombre';
                        const chapa = document.getElementById('chapa-' + idx)?.value || 'N/A';

                        // Card de m√°quina
                        const cardY = y;
                        const cardHeight = 700;
                        dibujarCard(padding, cardY, canvas.width - (padding * 2), cardHeight, '#F8FAFC', '#CBD5E1', 2);

                        // Header: "M√ÅQUINA #N"
                        const headerY = cardY + 50;
                        const headerHeight = 60;
                        const headerBg = '#E2E8F0';
                        const headerBorder = '#CBD5E1';

                        // Dibujar recuadro del header
                        ctx.fillStyle = headerBg;
                        ctx.strokeStyle = headerBorder;
                        ctx.lineWidth = 2;
                        ctx.fillRect(padding + cardPadding, headerY, canvas.width - (padding * 2) - (cardPadding * 2), headerHeight);
                        ctx.strokeRect(padding + cardPadding, headerY, canvas.width - (padding * 2) - (cardPadding * 2), headerHeight);

                        // Texto del header
                        ctx.font = 'bold 24px Arial';
                        ctx.fillStyle = '#000000';
                        ctx.textAlign = 'center';
                        ctx.fillText(`M√ÅQUINA #${i + 1}`, canvas.width / 2, headerY + 38);
                        ctx.textAlign = 'left';

                        // Grid principal - Columnas JUEGO y CHAPA
                        const gridStartY = headerY + headerHeight;
                        const cardContentWidth = canvas.width - (padding * 2) - (cardPadding * 2);
                        const col1X = padding + cardPadding;
                        const col2X = col1X + (cardContentWidth / 2);
                        const colWidth = cardContentWidth / 2;
                        const rowHeight = 80;

                        // Fila 1: JUEGO | CHAPA (headers)
                        ctx.fillStyle = '#F1F5F9';
                        ctx.fillRect(col1X, gridStartY, colWidth, rowHeight);
                        ctx.fillRect(col2X, gridStartY, colWidth, rowHeight);

                        ctx.strokeStyle = '#CBD5E1';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(col1X, gridStartY, colWidth, rowHeight);
                        ctx.strokeRect(col2X, gridStartY, colWidth, rowHeight);

                        ctx.font = 'bold 28px Arial';
                        ctx.fillStyle = '#000000';
                        ctx.textAlign = 'center';
                        ctx.fillText('JUEGO', col1X + colWidth / 2, gridStartY + 50);
                        ctx.fillText('CHAPA', col2X + colWidth / 2, gridStartY + 50);

                        // Fila 2: Valores de JUEGO y CHAPA
                        const row2Y = gridStartY + rowHeight;
                        ctx.fillStyle = '#FFFFFF';
                        ctx.fillRect(col1X, row2Y, colWidth, rowHeight);
                        ctx.fillRect(col2X, row2Y, colWidth, rowHeight);
                        ctx.strokeRect(col1X, row2Y, colWidth, rowHeight);
                        ctx.strokeRect(col2X, row2Y, colWidth, rowHeight);

                        ctx.font = 'bold 26px Arial';
                        ctx.fillStyle = '#1E293B';
                        ctx.fillText(juego, col1X + colWidth / 2, row2Y + 50);
                        ctx.fillText(chapa, col2X + colWidth / 2, row2Y + 50);
                        ctx.textAlign = 'left';

                        // Obtener valores
                        const epa = document.getElementById('epa-' + idx)?.value || '0';
                        const spa = document.getElementById('spa-' + idx)?.value || '0';
                        const epant = document.getElementById('epant-' + idx)?.value || '0';
                        const spant = document.getElementById('spant-' + idx)?.value || '0';
                        const dpe = document.getElementById('dpe-' + idx)?.textContent || '0';
                        const dps = document.getElementById('dps-' + idx)?.textContent || '0';
                        const eia = document.getElementById('eia-' + idx)?.value || '0';
                        const sia = document.getElementById('sia-' + idx)?.value || '0';
                        const eiant = document.getElementById('eiant-' + idx)?.value || '0';
                        const siant = document.getElementById('siant-' + idx)?.value || '0';
                        const die = document.getElementById('die-' + idx)?.textContent || '0';
                        const dis = document.getElementById('dis-' + idx)?.textContent || '0';
                        const ganancia = document.getElementById('ganancia-' + idx)?.textContent || '0';
                        const porcentajePremios = document.getElementById('porcentajePremios-' + idx)?.textContent || '0%';

                        // Grid de datos: 4 columnas (Entrada/Salida PANTALLA + Entrada/Salida INTERNO)
                        const dataGridStartY = row2Y + rowHeight;
                        const cellWidth = cardContentWidth / 4;
                        const cellHeight = 70;

                        // Headers de las 4 columnas
                        const headers = ['ENTRADA', 'SALIDA', 'ENTRADA', 'SALIDA'];
                        ctx.font = 'bold 20px Arial';
                        ctx.fillStyle = '#000000';
                        ctx.textAlign = 'center';

                        for (let colIdx = 0; colIdx < 4; colIdx++) {
                            const cellX = col1X + (colIdx * cellWidth);

                            // Fondo
                            ctx.fillStyle = '#E0E7FF';
                            ctx.fillRect(cellX, dataGridStartY, cellWidth, cellHeight);

                            // Borde
                            ctx.strokeStyle = '#CBD5E1';
                            ctx.lineWidth = 2;
                            ctx.strokeRect(cellX, dataGridStartY, cellWidth, cellHeight);

                            // Texto
                            ctx.fillStyle = '#000000';
                            ctx.fillText(headers[colIdx], cellX + cellWidth / 2, dataGridStartY + 45);
                        }

                        // Fila de valores ACTUALES
                        const valuesRowY = dataGridStartY + cellHeight;
                        const valuesActuales = [
                            epa,   // Col 1: PANTALLA Entrada
                            spa,    // Col 2: PANTALLA Salida
                            eia,    // Col 3: INTERNO Entrada
                            sia      // Col 4: INTERNO Salida
                        ];

                        ctx.font = 'bold 24px Arial';
                        ctx.fillStyle = '#1E293B';

                        for (let colIdx = 0; colIdx < 4; colIdx++) {
                            const cellX = col1X + (colIdx * cellWidth);

                            // Fondo blanco
                            ctx.fillStyle = '#FFFFFF';
                            ctx.fillRect(cellX, valuesRowY, cellWidth, cellHeight);

                            // Borde
                            ctx.strokeRect(cellX, valuesRowY, cellWidth, cellHeight);

                            // Valor
                            ctx.fillStyle = '#1E293B';
                            ctx.fillText(valuesActuales[colIdx], cellX + cellWidth / 2, valuesRowY + 45);
                        }

                        // Fila de valores ANTERIORES
                        const valuesAntRowY = valuesRowY + cellHeight;
                        const valuesAnteriores = [
                            epant,  // Col 1: PANTALLA Entrada Ant
                            spant,   // Col 2: PANTALLA Salida Ant
                            eiant,   // Col 3: INTERNO Entrada Ant
                            siant     // Col 4: INTERNO Salida Ant
                        ];

                        for (let colIdx = 0; colIdx < 4; colIdx++) {
                            const cellX = col1X + (colIdx * cellWidth);

                            // Fondo blanco
                            ctx.fillStyle = '#FFFFFF';
                            ctx.fillRect(cellX, valuesAntRowY, cellWidth, cellHeight);

                            // Borde
                            ctx.strokeRect(cellX, valuesAntRowY, cellWidth, cellHeight);

                            // Valor
                            ctx.fillStyle = '#64748B';
                            ctx.fillText(valuesAnteriores[colIdx], cellX + cellWidth / 2, valuesAntRowY + 45);
                        }

                        // Fila de RESULTADOS
                        const resultadosRowY = valuesAntRowY + cellHeight;
                        const resultados = [
                            dpe,  // Col 1: Resultado Entrada PANTALLA
                            dps,   // Col 2: Resultado Salida PANTALLA
                            die,   // Col 3: Resultado Entrada INTERNO
                            dis     // Col 4: Resultado Salida INTERNO
                        ];

                        // Headers "RESULTADO" para cada columna
                        ctx.fillStyle = '#FEF3C7';

                        for (let colIdx = 0; colIdx < 4; colIdx++) {
                            const cellX = col1X + (colIdx * cellWidth);

                            // Fondo amarillo claro
                            ctx.fillStyle = '#FEF3C7';
                            ctx.fillRect(cellX, resultadosRowY, cellWidth, cellHeight);

                            // Borde
                            ctx.strokeRect(cellX, resultadosRowY, cellWidth, cellHeight);

                            // Label "RESULTADO"
                            ctx.fillStyle = '#78716C';
                            ctx.font = 'bold 16px Arial';
                            ctx.fillText('RESULTADO', cellX + cellWidth / 2, resultadosRowY + 25);

                            // Valor del resultado
                            ctx.fillStyle = '#D97706';
                            ctx.font = 'bold 26px Arial';
                            ctx.fillText(resultados[colIdx], cellX + cellWidth / 2, resultadosRowY + 55);
                        }

                        // Footer: GANANCIA y % PAGO
                        const footerY = resultadosRowY + cellHeight;
                        const footerHeight = 100;

                        // Columna GANANCIA (izquierda)
                        ctx.fillStyle = '#D1FAE5';
                        ctx.fillRect(col1X, footerY, colWidth, footerHeight);
                        ctx.strokeRect(col1X, footerY, colWidth, footerHeight);

                        ctx.textAlign = 'center';
                        ctx.font = 'bold 20px Arial';
                        ctx.fillStyle = '#065F46';
                        ctx.fillText('GANANCIA', col1X + colWidth / 2, footerY + 35);

                        ctx.font = 'bold 32px Arial';
                        ctx.fillStyle = '#10B981';
                        ctx.fillText(`$${ganancia}`, col1X + colWidth / 2, footerY + 75);

                        // Columna % PAGO (derecha)
                        ctx.fillStyle = '#DBEAFE';
                        ctx.fillRect(col2X, footerY, colWidth, footerHeight);
                        ctx.strokeRect(col2X, footerY, colWidth, footerHeight);

                        ctx.font = 'bold 20px Arial';
                        ctx.fillStyle = '#1E40AF';
                        ctx.fillText('% PAGO', col2X + colWidth / 2, footerY + 35);

                        ctx.font = 'bold 32px Arial';
                        ctx.fillStyle = '#3B82F6';
                        ctx.fillText(`${porcentajePremios}`, col2X + colWidth / 2, footerY + 75);

                        ctx.textAlign = 'left';

                        y = cardY + cardHeight + 30;
                    }

                    // ========== OPCIONES DEL BOT√ìN M√ÅS ==========
                    if (opcionesSeleccionadas.length > 0) {
                        const cardOpcionesY = y;
                        let alturaOpcionesCard = 100 + (opcionesSeleccionadas.length * 60);

                        dibujarCard(padding, cardOpcionesY, canvas.width - (padding * 2), alturaOpcionesCard, '#FEF3C7', '#F59E0B', 2);

                        y += 50;
                        ctx.fillStyle = '#D97706';
                        ctx.font = 'bold 36px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText('OPCIONES ADICIONALES', canvas.width / 2, y);
                        y += 60;

                        ctx.textAlign = 'left';
                        ctx.font = '28px Arial';

                        // Mapear nombres internos a IDs reales
                        const opcionesMap = {
                            'abono': { id: 'abono', label: 'ABONO', formato: '$' },
                            'dif': { id: 'difPorcentaje', label: 'DIF%', formato: '$' },
                            'deposito': { id: 'deposito', label: 'DEP√ìSITO', formato: '$' },
                            'pendiente': { id: 'pendiente', label: 'PENDIENTE', formato: '$' }
                        };

                        // Dibujar cada opci√≥n seleccionada
                        opcionesSeleccionadas.forEach(opcion => {
                            const config = opcionesMap[opcion];
                            if (config) {
                                const valorInput = document.getElementById(config.id);
                                const valor = valorInput?.value || '0';

                                ctx.fillStyle = '#78716C';
                                ctx.fillText(config.label + ':', padding + cardPadding, y);
                                ctx.textAlign = 'right';
                                ctx.fillStyle = '#000000';
                                ctx.font = 'bold 30px Arial';
                                if (config.formato === '$') {
                                    ctx.fillText(`$${valor}`, canvas.width - padding - cardPadding, y);
                                } else {
                                    ctx.fillText(`${valor}%`, canvas.width - padding - cardPadding, y);
                                }
                                ctx.textAlign = 'left';
                                ctx.font = '28px Arial';
                                y += 50;
                            }
                        });

                        y += 40;
                    }

                    // ========== OBSERVACIONES Y ESTADO ==========
                    if (observaciones || estado) {
                        const cardInfoY = y;
                        let alturaInfoCard = 80;

                        // Calcular altura necesaria para observaciones (multiline)
                        if (observaciones) {
                            const lineasObservaciones = Math.ceil(observaciones.length / 60) || 1;
                            alturaInfoCard += 60 + (lineasObservaciones * 35);
                        }

                        // Agregar altura para estado
                        if (estado) {
                            alturaInfoCard += 60;
                        }

                        dibujarCard(padding, cardInfoY, canvas.width - (padding * 2), alturaInfoCard, '#EFF6FF', '#3B82F6', 2);

                        y += 50;
                        ctx.fillStyle = '#1E40AF';
                        ctx.font = 'bold 36px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText('INFORMACI√ìN ADICIONAL', canvas.width / 2, y);
                        y += 50;

                        ctx.textAlign = 'left';

                        // OBSERVACIONES
                        if (observaciones) {
                            ctx.fillStyle = '#64748B';
                            ctx.font = 'bold 28px Arial';
                            ctx.fillText('OBSERVACIONES:', padding + cardPadding, y);
                            y += 40;

                            ctx.fillStyle = '#000000';
                            ctx.font = '26px Arial';

                            // Dividir texto en l√≠neas para que quepa en el ancho
                            const maxAncho = canvas.width - (padding * 2) - (cardPadding * 2);
                            const palabras = observaciones.split(' ');
                            let lineaActual = '';

                            palabras.forEach((palabra, index) => {
                                const testLinea = lineaActual + palabra + ' ';
                                const medida = ctx.measureText(testLinea);

                                if (medida.width > maxAncho && lineaActual !== '') {
                                    ctx.fillText(lineaActual, padding + cardPadding, y);
                                    y += 35;
                                    lineaActual = palabra + ' ';
                                } else {
                                    lineaActual = testLinea;
                                }

                                // Si es la √∫ltima palabra, dibujar la l√≠nea final
                                if (index === palabras.length - 1) {
                                    ctx.fillText(lineaActual, padding + cardPadding, y);
                                    y += 45;
                                }
                            });
                        }

                        // ESTADO
                        if (estado) {
                            ctx.fillStyle = '#64748B';
                            ctx.font = 'bold 28px Arial';
                            ctx.fillText('ESTADO:', padding + cardPadding, y);

                            ctx.fillStyle = '#000000';
                            ctx.font = '26px Arial';
                            ctx.fillText(estado, padding + cardPadding + 140, y);
                            y += 70;
                        }

                        y += 10;
                    }

                    // ========== RESUMEN TOTAL ==========
                    const cardResY = y;
                    const cardResHeight = 900;
                    dibujarCard(padding, cardResY, canvas.width - (padding * 2), cardResHeight, '#F8FAFC', '#8B5CF6', 3);

                    y += 60;
                    ctx.fillStyle = '#8B5CF6';
                    ctx.font = 'bold 44px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('RESUMEN TOTAL', canvas.width / 2, y);
                    y += 70;

                    // Funci√≥n para dibujar l√≠nea de resumen
                    function dibujarLineaResumen(label, valor, destacado = false) {
                        ctx.textAlign = 'left';
                        ctx.fillStyle = destacado ? '#000000' : '#64748B';
                        ctx.font = destacado ? 'bold 32px Arial' : '28px Arial';
                        ctx.fillText(label, padding + cardPadding, y);

                        ctx.textAlign = 'right';
                        ctx.fillStyle = '#000000';
                        ctx.font = destacado ? 'bold 34px Arial' : '30px Arial';
                        ctx.fillText(valor, canvas.width - padding - cardPadding, y);
                        y += destacado ? 50 : 45;
                    }

                    dibujarLineaResumen('COLECTADO:', document.getElementById('colectado').textContent);
                    dibujarLineaResumen('PREMIOS:', document.getElementById('premios').textContent);
                    dibujarLineaResumen('RETENCI√ìN 5.5%:', document.getElementById('retencion').textContent);
                    dibujarLineaResumen('PREMIOS NETO:', document.getElementById('premiosNeto').textContent);
                    dibujarLineaResumen('IMPUESTO JCJ:', document.getElementById('impuestoDisplay').textContent);
                    dibujarLineaResumen('DEVOLUCI√ìN:', document.getElementById('devolucionDisplay').textContent);
                    y += 10;
                    dibujarLineaResumen('A REPARTIR:', document.getElementById('aRepartir').textContent, true);
                    y += 5;
                    dibujarLineaResumen('GANANCIA C/U:', document.getElementById('gananciaCU').textContent);
                    dibujarLineaResumen('GANANCIA CLIENTE:', document.getElementById('gananciaCliente').textContent);
                    y += 10;
                    dibujarLineaResumen('RECIBIDO CLIENTE:', document.getElementById('recibidoCliente').textContent, true);
                    y += 5;
                    dibujarLineaResumen('EMPRESA JCJ & LUCRO:', document.getElementById('empresaJCJ').textContent);
                    y += 10;
                    dibujarLineaResumen('RECIBIDO EMPRESA:', document.getElementById('recibidoEmpresa').textContent, true);
                    y += 30;

                    // A RECIBIR - Destacado
                    const cardRecY = y;
                    const cardRecHeight = 130;
                    dibujarCard(padding + cardPadding, cardRecY, canvas.width - (padding * 2) - (cardPadding * 2), cardRecHeight, '#DBEAFE', '#3B82F6', 3);

                    // Centrar verticalmente el texto en el medio de la tarjeta
                    const centroVertical = cardRecY + (cardRecHeight / 2) + 10;

                    ctx.fillStyle = '#000000';
                    ctx.font = 'bold 36px Arial';
                    ctx.textAlign = 'left';
                    ctx.fillText('A RECIBIR:', padding + cardPadding + 30, centroVertical);

                    ctx.textAlign = 'right';
                    ctx.fillStyle = '#1D4ED8';
                    ctx.font = 'bold 50px Arial';
                    ctx.fillText(`$${document.getElementById('aRecibir').textContent}`, canvas.width - padding - cardPadding - 30, centroVertical + 5);

                    // Convertir canvas a imagen
                    try {
                        const dataURL = canvas.toDataURL('image/png', 1.0);
                        const base64 = dataURL.split(',')[1];

                        if (typeof Android !== 'undefined' && Android.compartirImagen) {
                            Android.compartirImagen(base64, `colecta_${nombreEst.replace(/[^a-zA-Z0-9]/g, '_')}_${fecha.replace(/[^a-zA-Z0-9]/g, '_')}.png`, nombreEst);
                            showSuccess('Imagen lista para compartir', '‚úÖ Compartir');
                        } else {
                            // Fallback para navegador
                            const a = document.createElement('a');
                            a.href = dataURL;
                            a.download = `colecta_${nombreEst}_${fecha}.png`;
                            a.click();
                            showSuccess('Imagen descargada', '‚úÖ √âxito');
                        }
                    } catch (err) {
                        console.error('Error al convertir canvas:', err);
                        showError('Error al convertir imagen: ' + err.message, '‚ùå Error');
                    }

                } catch (e) {
                    showError('Error al generar imagen: ' + e.message, '‚ùå Error');
                }
            }, 300);
        }


        // ========== FUNCIONALIDAD PARA EL MODAL DE GASTOS (SOLO PARA REGISTRO, NO AFECTA C√ÅLCULOS) ==========

        function guardarColecta() {
            // Validar nombre del establecimiento
            const nombreEstablecimiento = document.getElementById('nombreEstablecimiento').value.trim();
            if (!nombreEstablecimiento) {
                showError('Por favor ingresa el nombre del establecimiento', '‚ö†Ô∏è Campo Requerido');
                document.getElementById('nombreEstablecimiento').focus();
                return;
            }

            // Validar que hay al menos una m√°quina
            if (machines.length === 0) {
                showError('Debes agregar al menos una m√°quina antes de guardar', '‚ö†Ô∏è Sin M√°quinas');
                return;
            }

            // Obtener fecha en formato ISO para guardar
            const fecha = document.getElementById('fechaColecta').dataset.fechaIso || getCurrentDate();

            // Recopilar y validar datos de todas las m√°quinas
            const maquinasData = [];
            const erroresValidacion = [];

            for (let i = 0; i < machines.length; i++) {
                const m = machines[i];
                const idx = m.index;

                // Verificar que la m√°quina existe en el DOM
                if (!document.getElementById('mw-' + idx)) continue;

                const numeroMaquina = maquinasData.length + 1;

                // Obtener valores de los campos
                const juego = document.getElementById('juego-' + idx)?.value.trim() || '';
                const chapa = document.getElementById('chapa-' + idx)?.value.trim() || '';
                const epa = document.getElementById('epa-' + idx)?.value.trim() || '';
                const spa = document.getElementById('spa-' + idx)?.value.trim() || '';
                const eia = document.getElementById('eia-' + idx)?.value.trim() || '';
                const sia = document.getElementById('sia-' + idx)?.value.trim() || '';

                // Validar campos requeridos
                if (!juego) {
                    erroresValidacion.push(`M√°quina #${numeroMaquina}: Falta el nombre del juego`);
                }
                if (!chapa) {
                    erroresValidacion.push(`M√°quina #${numeroMaquina}: Falta el n√∫mero de chapa`);
                }
                if (!epa) {
                    erroresValidacion.push(`M√°quina #${numeroMaquina}: Falta Entrada Actual (Pantalla)`);
                }
                if (!spa) {
                    erroresValidacion.push(`M√°quina #${numeroMaquina}: Falta Salida Actual (Pantalla)`);
                }
                if (!eia) {
                    erroresValidacion.push(`M√°quina #${numeroMaquina}: Falta Entrada Actual (Interno)`);
                }
                if (!sia) {
                    erroresValidacion.push(`M√°quina #${numeroMaquina}: Falta Salida Actual (Interno)`);
                }

                // Si hay errores en esta m√°quina, no agregarla
                if (erroresValidacion.length > 0) {
                    continue;
                }

                maquinasData.push({
                    juego: juego,
                    chapa: chapa,
                    pantalla: {
                        entradaActual: epa,
                        salidaActual: spa,
                        entradaAnterior: document.getElementById('epant-' + idx)?.value || '0',
                        salidaAnterior: document.getElementById('spant-' + idx)?.value || '0'
                    },
                    interno: {
                        entradaActual: eia,
                        salidaActual: sia,
                        entradaAnterior: document.getElementById('eiant-' + idx)?.value || '0',
                        salidaAnterior: document.getElementById('siant-' + idx)?.value || '0'
                    }
                });
            }

            // Si hay errores, mostrarlos y no guardar
            if (erroresValidacion.length > 0) {
                const mensajeError = erroresValidacion.join('<br>‚Ä¢ ');
                showError(
                    `Por favor completa los siguientes campos:<br><br>‚Ä¢ ${mensajeError}`,
                    '‚ö†Ô∏è Campos Incompletos'
                );
                return;
            }

            // Obtener valores de las opciones MAS (si existen)
            const abonoEl = document.getElementById('abono');
            const difPorcentajeEl = document.getElementById('difPorcentaje');
            const depositoEl = document.getElementById('deposito');
            const pendienteEl = document.getElementById('pendiente');

            // Obtener valores calculados del dashboard
            const gananciaEl = document.getElementById('gananciaCU');
            const impuestoJCJEl = document.getElementById('impuestoJCJ');
            const retencionEl = document.getElementById('retencion');

            // Obtener gananciaCU y validar que no sea negativa
            const gananciaCUValor = gananciaEl ? parseFloat(gananciaEl.textContent) || 0 : 0;
            const gananciaCUFinal = gananciaCUValor < 0 ? 0 : gananciaCUValor;

            const datosColecta = {
                maquinas: maquinasData,
                totales: {
                    totalEntradas: document.getElementById('totalEntradas').textContent,
                    totalPagos: document.getElementById('totalPagos').textContent,
                    aRecibir: parseFloat(document.getElementById('aRecibir').textContent) || 0,
                    abono: abonoEl ? parseFloat(abonoEl.value) || 0 : 0,
                    difPorcentaje: difPorcentajeEl ? parseFloat(difPorcentajeEl.value) || 0 : 0,
                    deposito: depositoEl ? parseFloat(depositoEl.value) || 0 : 0,
                    pendiente: pendienteEl ? parseFloat(pendienteEl.value) || 0 : 0,
                    gananciaCU: gananciaCUFinal,
                    impuestoJCJ: impuestoJCJEl ? parseFloat(impuestoJCJEl.value) || 0 : 0,
                    retencion55: retencionEl ? parseFloat(retencionEl.textContent) || 0 : 0
                }
            };

            // Guardar en SQLite a trav√©s de Android
            if (typeof Android !== 'undefined' && Android.guardarColecta) {
                try {
                    const resultado = JSON.parse(
                        Android.guardarColecta(nombreEstablecimiento, fecha, JSON.stringify(datosColecta))
                    );

                    if (resultado.success) {
                        showSuccess(
                            `Colecta guardada exitosamente<br><br>
                    <span style="font-size: 11px; opacity: 0.8;">
                    ‚Ä¢ Establecimiento: <strong>${nombreEstablecimiento}</strong><br>
                    ‚Ä¢ Fecha: <strong>${fecha}</strong><br>
                    ‚Ä¢ M√°quinas: <strong>${maquinasData.length}</strong><br>
                    ‚Ä¢ Total A Recibir: <strong>$${datosColecta.totales.aRecibir}</strong>
                    </span>`,
                            '‚úÖ Guardado'
                        );

                        // Recargar el dashboard para reflejar los nuevos datos
                        if (typeof cargarDashboard === 'function') {
                            setTimeout(() => {
                                cargarDashboard();
                            }, 1000);
                        }
                    } else {
                        showError('Error al guardar: ' + resultado.message, '‚ùå Error');
                    }
                } catch (e) {
                    showError('Error al guardar: ' + e.message, '‚ùå Error');
                }
            } else {
                showError('Esta funci√≥n solo est√° disponible en la aplicaci√≥n Android', '‚ö†Ô∏è No Disponible');
            }
        }

        // ========== FUNCIONES PARA VER ESTABLECIMIENTOS ANTERIORES ==========

        function cargarListaEstablecimientos() {
            if (typeof Android !== 'undefined' && Android.obtenerEstablecimientos) {
                try {
                    const establecimientos = JSON.parse(Android.obtenerEstablecimientos());
                    mostrarModalEstablecimientos(establecimientos);
                } catch (e) {
                    showError('Error al cargar establecimientos: ' + e.message, '‚ùå Error');
                }
            } else {
                showError('Esta funci√≥n solo est√° disponible en la aplicaci√≥n Android', '‚ö†Ô∏è No Disponible');
            }
        }

        // Variable global para guardar todos los establecimientos
        let todosLosEstablecimientos = [];

        function mostrarModalEstablecimientos(establecimientos) {
            const modal = document.getElementById('modalEstablecimientos');
            const lista = document.getElementById('listaEstablecimientos');
            const buscador = document.getElementById('buscadorEstablecimientos');

            // Guardar establecimientos en variable global
            todosLosEstablecimientos = establecimientos;

            // Limpiar el buscador
            buscador.value = '';

            // Renderizar lista
            renderizarListaEstablecimientos(establecimientos);

            modal.classList.remove('hidden');

            // Event listener para el buscador
            buscador.oninput = function() {
                const termino = this.value.toLowerCase().trim();

                if (termino === '') {
                    // Si no hay b√∫squeda, mostrar todos
                    renderizarListaEstablecimientos(todosLosEstablecimientos);
                } else {
                    // Filtrar establecimientos por nombre
                    const filtrados = todosLosEstablecimientos.filter(est =>
                        est.nombre.toLowerCase().includes(termino)
                    );
                    renderizarListaEstablecimientos(filtrados);
                }
            };

            // NO hacer focus autom√°tico para evitar que el teclado oculte el modal
        }

        function renderizarListaEstablecimientos(establecimientos) {
            const lista = document.getElementById('listaEstablecimientos');
            const buscador = document.getElementById('buscadorEstablecimientos');
            const contador = document.getElementById('contadorResultados');
            const hasBusqueda = buscador && buscador.value.trim() !== '';

            // Actualizar contador
            if (contador) {
                if (todosLosEstablecimientos.length === 0) {
                    contador.textContent = '';
                } else if (hasBusqueda) {
                    contador.textContent = `Mostrando ${establecimientos.length} de ${todosLosEstablecimientos.length} establecimientos`;
                } else {
                    contador.textContent = `${establecimientos.length} establecimiento${establecimientos.length !== 1 ? 's' : ''} guardado${establecimientos.length !== 1 ? 's' : ''}`;
                }
            }

            if (establecimientos.length === 0) {
                if (hasBusqueda) {
                    // No hay resultados de b√∫squeda
                    lista.innerHTML = `
                        <div class="text-center py-8 text-gray-400">
                            <p class="text-4xl mb-3">üîç</p>
                            <p>No se encontraron establecimientos</p>
                            <p class="text-sm mt-2">Intenta con otro t√©rmino de b√∫squeda</p>
                        </div>
                    `;
                } else {
                    // No hay establecimientos guardados
                    lista.innerHTML = `
                        <div class="text-center py-8 text-gray-400">
                            <p class="text-4xl mb-3">üìã</p>
                            <p>No hay establecimientos guardados</p>
                        </div>
                    `;
                }
            } else {
                lista.innerHTML = establecimientos.map(est => `
                    <div class="bg-slate-700 bg-opacity-50 rounded-lg p-4 border border-purple-500 border-opacity-30 hover:border-opacity-60 transition-all establecimiento-item">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-white font-bold text-lg">${est.nombre}</h3>
                            <span class="text-white text-sm">${est.fecha}</span>
                        </div>
                        <div class="flex gap-2 mt-3">
                            <button onclick="cargarEstablecimiento(${est.id})"
                                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 rounded-lg transition-all">
                                üìÇ Cargar
                            </button>
                            <button onclick="eliminarEstablecimientoConfirm(${est.id}, '${est.nombre}')"
                                class="bg-red-600 hover:bg-red-700 text-white text-sm font-medium px-4 py-2 rounded-lg transition-all">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function cargarEstablecimiento(id) {
            if (typeof Android !== 'undefined' && Android.obtenerEstablecimiento) {
                try {
                    const establecimiento = JSON.parse(Android.obtenerEstablecimiento(id));

                    if (establecimiento && establecimiento.datos) {
                        // Cargar nombre del establecimiento
                        document.getElementById('nombreEstablecimiento').value = establecimiento.nombre;

                        // Actualizar fecha a la actual (nueva colecta)
                        const fechaActual = getCurrentDate(); // Formato ISO
                        const fechaActualElement = document.getElementById('fechaColecta');
                        fechaActualElement.textContent = formatDateForDisplay(fechaActual); // Mostrar formato visual
                        fechaActualElement.dataset.fechaIso = fechaActual; // Guardar ISO en data attribute

                        // Limpiar m√°quinas actuales
                        machines = [];
                        document.getElementById('machinesContainer').innerHTML = '';
                        machineCount = 0;

                        // Cargar m√°quinas guardadas
                        const maquinas = establecimiento.datos.maquinas;
                        if (maquinas && Array.isArray(maquinas)) {
                            maquinas.forEach(maquina => {
                                addMachineAndLoad(maquina);
                            });
                        }

                        cerrarModalEstablecimientos();
                        showSuccess(`Establecimiento "${establecimiento.nombre}" cargado exitosamente<br>Los valores actuales guardados ahora est√°n en "Anteriores"`, '‚úÖ Cargado');
                    }
                } catch (e) {
                    showError('Error al cargar establecimiento: ' + e.message, '‚ùå Error');
                }
            }
        }

        function addMachineAndLoad(maquina) {
            // Agregar m√°quina vac√≠a primero
            addSingleMachine();

            // Obtener el √≠ndice de la m√°quina reci√©n agregada
            const idx = machineCount - 1;

            // Cargar datos en la m√°quina con un timeout m√°s largo
            setTimeout(() => {
                try {
                    const machineWrapper = document.getElementById('mw-' + idx);
                    if (!machineWrapper) {
                        console.error('No se encontr√≥ m√°quina con √≠ndice:', idx);
                        return;
                    }

                    // Verificar estructura de datos
                    if (!maquina || !maquina.pantalla || !maquina.interno) {
                        console.error('Estructura de datos incorrecta:', maquina);
                        return;
                    }

                    // Datos b√°sicos
                    const juegoEl = document.getElementById('juego-' + idx);
                    const chapaEl = document.getElementById('chapa-' + idx);
                    if (juegoEl) juegoEl.value = maquina.juego || '';
                    if (chapaEl) chapaEl.value = maquina.chapa || '';

                    // Pantalla - actuales guardados ‚Üí anteriores nuevos
                    const epantEl = document.getElementById('epant-' + idx);
                    const spantEl = document.getElementById('spant-' + idx);
                    const epaEl = document.getElementById('epa-' + idx);
                    const spaEl = document.getElementById('spa-' + idx);

                    if (epantEl) epantEl.value = maquina.pantalla.entradaActual || '0';
                    if (spantEl) spantEl.value = maquina.pantalla.salidaActual || '0';
                    if (epaEl) epaEl.value = '';
                    if (spaEl) spaEl.value = '';

                    // Interno - actuales guardados ‚Üí anteriores nuevos
                    const eiantEl = document.getElementById('eiant-' + idx);
                    const siantEl = document.getElementById('siant-' + idx);
                    const eiaEl = document.getElementById('eia-' + idx);
                    const siaEl = document.getElementById('sia-' + idx);

                    if (eiantEl) eiantEl.value = maquina.interno.entradaActual || '0';
                    if (siantEl) siantEl.value = maquina.interno.salidaActual || '0';
                    if (eiaEl) eiaEl.value = '';
                    if (siaEl) siaEl.value = '';

                    // Calcular valores
                    calc(idx);
                } catch (e) {
                    console.error('Error al cargar m√°quina:', e);
                    showError('Error al cargar m√°quina: ' + e.message, '‚ùå Error');
                }
            }, 200);
        }

        function eliminarEstablecimientoConfirm(id, nombre) {
            // Crear notificaci√≥n de confirmaci√≥n
            const confirmId = 'confirm-delete-' + Date.now();

            const confirmHTML = `
                <div id="${confirmId}" class="notification notification-warning show" style="max-width: 350px;">
                    <div class="notification-content">
                        <div class="notification-icon">üóëÔ∏è</div>
                        <div class="notification-text">
                            <div class="notification-title">¬øEliminar Establecimiento?</div>
                            <div class="notification-message">
                                <strong>${nombre}</strong>
                                <br><br>
                                <span style="font-size: 11px; opacity: 0.8;">
                                Esta acci√≥n no se puede deshacer
                                </span>
                            </div>
                            <div style="display: flex; gap: 8px; margin-top: 12px;">
                                <button onclick="document.getElementById('${confirmId}').remove();"
                                    class="flex-1 bg-slate-700 hover:bg-slate-600 text-white text-xs font-medium py-2.5 rounded-lg transition-all flex items-center justify-center gap-1">
                                    <span>‚úï</span> Cancelar
                                </button>
                                <button onclick="
                                    document.getElementById('${confirmId}').remove();
                                    eliminarEstablecimiento(${id});
                                "
                                    class="flex-1 bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-700 hover:to-orange-700 text-white text-xs font-medium py-2.5 rounded-lg transition-all flex items-center justify-center gap-1">
                                    <span>üóëÔ∏è</span> S√≠, Eliminar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            let container = document.getElementById('notification-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'notification-container';
                container.className = 'notification-container';
                document.body.appendChild(container);
            }

            container.insertAdjacentHTML('afterbegin', confirmHTML);
        }

        function eliminarEstablecimiento(id) {
            if (typeof Android !== 'undefined' && Android.eliminarEstablecimiento) {
                try {
                    const resultado = JSON.parse(Android.eliminarEstablecimiento(id));
                    if (resultado.success) {
                        showSuccess('Establecimiento eliminado exitosamente', '‚úÖ Eliminado');
                        cargarListaEstablecimientos(); // Recargar lista
                    } else {
                        showError('Error al eliminar: ' + resultado.message, '‚ùå Error');
                    }
                } catch (e) {
                    showError('Error al eliminar: ' + e.message, '‚ùå Error');
                }
            }
        }

        function cerrarModalEstablecimientos() {
            document.getElementById('modalEstablecimientos').classList.add('hidden');
        }

        // Event listener para cerrar el modal
        document.getElementById('btnCerrarModal').addEventListener('click', cerrarModalEstablecimientos);

        // Cerrar modal al hacer clic fuera
        document.getElementById('modalEstablecimientos').addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModalEstablecimientos();
            }
        });

        function showGastosModal() {
            // Verificar si ya hay un modal abierto
            if (document.getElementById('gastosModal')) {
                return;
            }

            const modalHTML = `
    <div id="gastosModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="card-glass rounded-xl p-6 max-w-md w-full">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-bold text-white">Seleccionar Tipo</h3>
                <button id="closeGastosModal" class="text-slate-400 hover:text-white text-xl">
                    ‚úï
                </button>
            </div>
            
            <!-- Paso 1: Seleccionar Tipo -->
            <div id="pasoSeleccion" class="space-y-3">
                <p class="text-sm text-slate-300 mb-4 text-center">¬øQu√© desea registrar?</p>
                
                <button data-tipo="gasto" class="w-full bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-700 hover:to-orange-700 text-white font-semibold py-3 rounded-lg transition-all flex items-center justify-between px-4">
                    <span>GASTO</span>
                    <span class="text-xs bg-red-800 px-2 py-1 rounded">Monto negativo</span>
                </button>
                
                <button data-tipo="abono" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-semibold py-3 rounded-lg transition-all flex items-center justify-between px-4">
                    <span>ABONO</span>
                    <span class="text-xs bg-green-800 px-2 py-1 rounded">Monto positivo</span>
                </button>
                
                <button data-tipo="deposito" class="w-full bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white font-semibold py-3 rounded-lg transition-all flex items-center justify-between px-4">
                    <span>DEP√ìSITO</span>
                    <span class="text-xs bg-blue-800 px-2 py-1 rounded">Monto positivo</span>
                </button>
            </div>
            
            <!-- Paso 2: Formulario de GASTO (oculto inicialmente) -->
            <div id="formGasto" class="hidden">
                <div class="flex items-center gap-3 mb-4">
                    <button id="volverGasto" class="text-slate-400 hover:text-white">
                        ‚Üê
                    </button>
                    <h4 class="text-lg font-bold text-white">Registrar Gasto</h4>
                </div>
                
                <div class="bg-gradient-to-r from-red-600 to-orange-600 rounded-lg p-4 mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <label class="text-sm font-bold text-white">GASTO</label>
                        <span class="text-xs text-red-100">Monto negativo</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-lg text-red-200">- $</span>
                        <input type="number" id="gastoMonto" 
                            class="flex-1 bg-red-800 bg-opacity-30 border border-red-400 rounded-lg px-3 py-2 text-white text-center font-bold focus:outline-none focus:border-red-300"
                            placeholder="0.00" step="0.01" value="0" autofocus>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-xs font-medium text-slate-300 mb-2">DESCRIPCI√ìN (opcional)</label>
                    <input type="text" id="gastoDescripcion"
                        class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-slate-500"
                        placeholder="Ej: Mantenimiento, Reparaci√≥n, etc.">
                </div>
                
                <button id="guardarGasto" 
                    class="w-full bg-gradient-to-r from-red-600 to-orange-600 text-white font-semibold py-3 rounded-lg hover:from-red-700 hover:to-orange-700 transition-all mt-2">
                    üíæ Guardar Gasto
                </button>
            </div>
            
            <!-- Paso 2: Formulario de ABONO (oculto inicialmente) -->
            <div id="formAbono" class="hidden">
                <div class="flex items-center gap-3 mb-4">
                    <button id="volverAbono" class="text-slate-400 hover:text-white">
                        ‚Üê
                    </button>
                    <h4 class="text-lg font-bold text-white">Registrar Abono</h4>
                </div>
                
                <div class="bg-gradient-to-r from-green-600 to-emerald-600 rounded-lg p-4 mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <label class="text-sm font-bold text-white">ABONO</label>
                        <span class="text-xs text-green-100">Monto positivo</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-lg text-green-200">+ $</span>
                        <input type="number" id="abonoMonto" 
                            class="flex-1 bg-green-800 bg-opacity-30 border border-green-400 rounded-lg px-3 py-2 text-white text-center font-bold focus:outline-none focus:border-green-300"
                            placeholder="0.00" step="0.01" value="0" autofocus>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-xs font-medium text-slate-300 mb-2">DESCRIPCI√ìN (opcional)</label>
                    <input type="text" id="abonoDescripcion"
                        class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-slate-500"
                        placeholder="Ej: Pago cliente, Reembolso, etc.">
                </div>
                
                <button id="guardarAbono" 
                    class="w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white font-semibold py-3 rounded-lg hover:from-green-700 hover:to-emerald-700 transition-all mt-2">
                    üíæ Guardar Abono
                </button>
            </div>
            
            <!-- Paso 2: Formulario de DEP√ìSITO (oculto inicialmente) -->
            <div id="formDeposito" class="hidden">
                <div class="flex items-center gap-3 mb-4">
                    <button id="volverDeposito" class="text-slate-400 hover:text-white">
                        ‚Üê
                    </button>
                    <h4 class="text-lg font-bold text-white">Registrar Dep√≥sito</h4>
                </div>
                
                <div class="bg-gradient-to-r from-blue-600 to-cyan-600 rounded-lg p-4 mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <label class="text-sm font-bold text-white">DEP√ìSITO</label>
                        <span class="text-xs text-blue-100">Monto positivo</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-lg text-blue-200">+ $</span>
                        <input type="number" id="depositoMonto" 
                            class="flex-1 bg-blue-800 bg-opacity-30 border border-blue-400 rounded-lg px-3 py-2 text-white text-center font-bold focus:outline-none focus:border-blue-300"
                            placeholder="0.00" step="0.01" value="0" autofocus>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-xs font-medium text-slate-300 mb-2">DESCRIPCI√ìN (opcional)</label>
                    <input type="text" id="depositoDescripcion"
                        class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-slate-500"
                        placeholder="Ej: Dep√≥sito bancario, Transferencia, etc.">
                </div>
                
                <button id="guardarDeposito" 
                    class="w-full bg-gradient-to-r from-blue-600 to-cyan-600 text-white font-semibold py-3 rounded-lg hover:from-blue-700 hover:to-cyan-700 transition-all mt-2">
                    üíæ Guardar Dep√≥sito
                </button>
            </div>
            
            <!-- Informaci√≥n -->
            <div class="mt-4 p-3 bg-blue-900 bg-opacity-30 rounded-lg">
                <p class="text-xs text-blue-200 text-center">
                    ‚ìò Esta informaci√≥n se guardar√° para registro futuro. No afecta los c√°lculos actuales.
                </p>
            </div>
        </div>
    </div>
    `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // Funci√≥n para cambiar entre pasos
            function mostrarFormulario(tipo) {
                // Ocultar paso de selecci√≥n
                document.getElementById('pasoSeleccion').classList.add('hidden');

                // Mostrar formulario correspondiente
                document.getElementById(`form${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`).classList.remove('hidden');
            }

            function volverASeleccion() {
                // Ocultar todos los formularios
                document.getElementById('formGasto').classList.add('hidden');
                document.getElementById('formAbono').classList.add('hidden');
                document.getElementById('formDeposito').classList.add('hidden');

                // Mostrar paso de selecci√≥n
                document.getElementById('pasoSeleccion').classList.remove('hidden');
            }

            // Event listeners para botones de selecci√≥n
            document.querySelectorAll('[data-tipo]').forEach(btn => {
                btn.addEventListener('click', function () {
                    const tipo = this.getAttribute('data-tipo');
                    mostrarFormulario(tipo);
                });
            });

            // Event listeners para botones "volver"
            document.getElementById('volverGasto').addEventListener('click', volverASeleccion);
            document.getElementById('volverAbono').addEventListener('click', volverASeleccion);
            document.getElementById('volverDeposito').addEventListener('click', volverASeleccion);

            // Event listeners para guardar
            document.getElementById('guardarGasto').addEventListener('click', function () {
                guardarRegistro('gasto');
            });

            document.getElementById('guardarAbono').addEventListener('click', function () {
                guardarRegistro('abono');
            });

            document.getElementById('guardarDeposito').addEventListener('click', function () {
                guardarRegistro('deposito');
            });

            // Funci√≥n para guardar registro
            function guardarRegistro(tipo) {
                const monto = parseFloat(document.getElementById(`${tipo}Monto`).value) || 0;
                const descripcion = document.getElementById(`${tipo}Descripcion`).value;

                // Validar que el monto sea mayor a 0
                if (monto === 0) {
                    showWarning('Por favor, ingresa un monto mayor a 0', '‚ö†Ô∏è Monto inv√°lido');
                    return;
                }

                const fecha = formatDateSQL(new Date());
                const tipoTexto = tipo.toUpperCase();
                const signo = tipo === 'gasto' ? '-' : '+';
                const icono = tipo === 'gasto' ? 'üí∏' : tipo === 'abono' ? 'üí∞' : 'üè¶';
                const colorTipo = tipo === 'gasto' ? 'text-red-300' : tipo === 'abono' ? 'text-green-300' : 'text-blue-300';

                // Guardar en base de datos si Android est√° disponible
                if (typeof Android !== 'undefined' && Android.guardarMovimiento) {
                    try {
                        const resultado = JSON.parse(
                            Android.guardarMovimiento(tipo, monto, descripcion, 0, '', fecha)
                        );

                        if (resultado.success) {
                            showSuccess(
                                `<span class="${colorTipo}">${tipoTexto}</span> registrado exitosamente<br><br>
                            <span style="font-size: 11px; opacity: 0.8;">
                            ‚Ä¢ Monto: <strong>${signo}$${monto.toFixed(2)}</strong><br>
                            ${descripcion ? `‚Ä¢ Descripci√≥n: ${descripcion}<br>` : ''}
                            ‚Ä¢ Hora: ${new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}
                            </span>`,
                                `${icono} ${tipoTexto} Guardado`
                            );

                            // Si estamos en el dashboard, recargar despu√©s de cerrar modal
                            if (dashboardState.currentPage === 'dashboard') {
                                setTimeout(() => cargarDashboard(), 500);
                            }
                        } else {
                            showError('Error al guardar: ' + resultado.message);
                            return;
                        }
                    } catch (error) {
                        console.error('Error al guardar movimiento:', error);
                        showError('Error al guardar el movimiento');
                        return;
                    }
                } else {
                    // Modo sin Android (para pruebas en navegador)
                    console.log("Android no disponible - Datos:", { tipo, monto, descripcion, fecha });
                    showSuccess(
                        `<span class="${colorTipo}">${tipoTexto}</span> registrado (modo prueba)<br><br>
                        <span style="font-size: 11px; opacity: 0.8;">
                        ‚Ä¢ Monto: <strong>${signo}$${monto.toFixed(2)}</strong><br>
                        ${descripcion ? `‚Ä¢ Descripci√≥n: ${descripcion}<br>` : ''}
                        ‚Ä¢ Hora: ${new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}
                        </span>`,
                        `${icono} ${tipoTexto} Guardado`
                    );
                }

                // Cerrar modal primero
                closeGastosModal();

                // Luego actualizar el campo ESTADO y hacer foco
                setTimeout(() => {
                    const estadoInput = document.getElementById('estado');
                    const estadoIcon = document.getElementById('estadoIcon');

                    if (estadoInput && estadoIcon) {
                        // Actualizar el estado
                        estadoInput.value = `üì§ ${tipoTexto} enviado a la nube`;
                        estadoInput.className = "w-full bg-purple-900 border border-purple-500 rounded-lg px-3 py-2 text-white font-medium focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50 transition-all duration-300";
                        estadoIcon.textContent = icono;

                        // Hacer foco con efecto
                        estadoInput.focus();
                        estadoInput.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center',
                            inline: 'nearest'
                        });

                        // Resaltar con animaci√≥n
                        estadoInput.classList.add('ring-2', 'ring-purple-500', 'ring-opacity-50');

                        // Quitar foco despu√©s de 3 segundos
                        setTimeout(() => {
                            if (estadoInput) {
                                estadoInput.blur();
                                estadoInput.classList.remove('ring-2', 'ring-purple-500', 'ring-opacity-50');
                            }
                        }, 3000);
                    }
                }, 300); // Peque√±o delay para que se cierre primero el modal
            }

            // Event listener para cerrar modal
            document.getElementById('closeGastosModal').addEventListener('click', closeGastosModal);

            // Cerrar modal con Escape
            function closeModalOnEscape(e) {
                if (e.key === 'Escape') {
                    closeGastosModal();
                }
            }

            document.addEventListener('keydown', closeModalOnEscape);

            // Cerrar modal haciendo clic fuera
            const modalElement = document.getElementById('gastosModal');
            if (modalElement) {
                modalElement.addEventListener('click', function (e) {
                    if (e.target.id === 'gastosModal') {
                        closeGastosModal();
                    }
                });
            }

        } // <--- AQU√ç FALTABA ESTE CIERRE DE LA FUNCI√ìN showGastosModal()

        function closeGastosModal() {
            const modal = document.getElementById('gastosModal');
            if (modal) {
                modal.remove();
            }
        }
        // ========== FIN FUNCIONALIDAD PARA EL MODAL DE GASTOS ==========


        // Funci√≥n para actualizar la etiqueta del bot√≥n MAS
        function actualizarEtiquetaMAS() {
            const masLabel = document.getElementById('masLabel');

            if (opcionesSeleccionadas.length === 0) {
                masLabel.textContent = 'MAS:';
                masLabel.classList.remove('active');
                document.getElementById('masSeleccionadas').classList.add('hidden');
            } else {
                masLabel.textContent = 'MAS: (' + opcionesSeleccionadas.length + ')';
                masLabel.classList.add('active');
                document.getElementById('masSeleccionadas').classList.remove('hidden');
            }
        }

        // Funci√≥n para obtener el valor actual de una opci√≥n MAS
        function obtenerValorOpcionMAS(opcion) {
            // Mapear si es necesario
            const opcionesMap = {
                'abono': 'abono',
                'dif': 'difPorcentaje',
                'deposito': 'deposito',
                'pendiente': 'pendiente'
            };

            const idReal = opcionesMap[opcion] || opcion;
            const inputOculto = document.getElementById(idReal);
            if (inputOculto) {
                return inputOculto.value || 0;
            }
            return 0;
        }
        // Funci√≥n para renderizar las opciones seleccionadas
        function renderizarOpcionesSeleccionadas() {
            const contenedor = document.getElementById('masSeleccionadas');
            contenedor.innerHTML = '';

            opcionesSeleccionadas.forEach(opcion => {
                // Mapear nombres internos a IDs reales
                const opcionesMap = {
                    'abono': 'abono',
                    'dif': 'difPorcentaje',  // dif interno -> difPorcentaje en HTML
                    'deposito': 'deposito',
                    'pendiente': 'pendiente'
                };

                const idReal = opcionesMap[opcion];
                const valorActual = obtenerValorOpcionMAS(idReal);
                const nombreOpcion = opcion.toUpperCase();
                let placeholder = '';

                // Determinar placeholder seg√∫n la opci√≥n
                switch (opcion) {
                    case 'abono': placeholder = 'Monto abono'; break;
                    case 'dif': placeholder = 'Porcentaje DIF'; break;
                    case 'deposito': placeholder = 'Monto dep√≥sito'; break;
                    case 'pendiente': placeholder = 'Monto pendiente'; break;
                }
                const opcionHTML = `
<div class="mas-option-selected bg-slate-800 bg-opacity-50 rounded-lg p-3 border border-purple-500 border-opacity-20 mb-2">
    <div class="flex items-center justify-between mb-2">
        <div class="flex items-center gap-2">
            <span class="text-sm font-bold text-white">${nombreOpcion}</span>
        </div>
        <button type="button" class="text-red-400 hover:text-red-300 text-sm px-2 py-1 rounded hover:bg-red-900 hover:bg-opacity-30" data-remove-mas="${opcion}">
            ‚úï Eliminar
        </button>
    </div>
    <div>
        <input type="number" class="w-full bg-slate-700 border border-purple-500 border-opacity-30 rounded px-2 py-1.5 text-white text-center font-bold focus:outline-none focus:border-purple-500 text-sm"
            value="${valorActual}" placeholder="${placeholder}" 
            data-mas-opcion="${idReal}"> <!-- Usa idReal en lugar de opcion -->
    </div>
</div>
`;
                contenedor.insertAdjacentHTML('beforeend', opcionHTML);
            });

            // Agregar event listeners a los botones de eliminar
            document.querySelectorAll('[data-remove-mas]').forEach(btn => {
                btn.addEventListener('click', function () {
                    const opcion = this.getAttribute('data-remove-mas');
                    deseleccionarOpcionMAS(opcion);
                });
            });

            // Agregar event listeners a los inputs
            document.querySelectorAll('[data-mas-opcion]').forEach(input => {
                input.addEventListener('input', function () {
                    const opcion = this.getAttribute('data-mas-opcion'); // Este ya es el ID real
                    const valor = this.value || 0;

                    // Actualizar el input oculto
                    const inputOculto = document.getElementById(opcion);
                    if (inputOculto) {
                        inputOculto.value = valor;
                        console.log(`Actualizado ${opcion}:`, valor); // DEBUG
                    }

                    // Recalcular totales
                    calculateFinalTotals();
                });
            });
        }

        // Funci√≥n para seleccionar una opci√≥n MAS
        function seleccionarOpcionMAS(opcion) {
            if (!opcionesSeleccionadas.includes(opcion)) {
                opcionesSeleccionadas.push(opcion);

                // Marcar checkbox como seleccionado
                const checkbox = document.querySelector(`.mas-option-checkbox[data-option="${opcion}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                }

                // Ocultar panel de todas las opciones
                document.getElementById('masTodasOpciones').classList.add('hidden');
                masTodasVisible = false;
                document.getElementById('masArrow').style.transform = 'rotate(0deg)';

                // Actualizar interfaz
                actualizarEtiquetaMAS();
                renderizarOpcionesSeleccionadas();
            }
        }

        // Funci√≥n para deseleccionar una opci√≥n MAS
        function deseleccionarOpcionMAS(opcion) {
            opcionesSeleccionadas = opcionesSeleccionadas.filter(item => item !== opcion);

            // Desmarcar checkbox
            const checkbox = document.querySelector(`.mas-option-checkbox[data-option="${opcion}"]`);
            if (checkbox) {
                checkbox.checked = false;
            }

            // Mapear opci√≥n interna a ID real
            const opcionesMap = {
                'abono': 'abono',
                'dif': 'difPorcentaje',
                'deposito': 'deposito',
                'pendiente': 'pendiente'
            };

            const idReal = opcionesMap[opcion] || opcion;

            // Limpiar el valor del input oculto
            const inputOculto = document.getElementById(idReal);
            if (inputOculto) {
                inputOculto.value = 0;
            }

            // Actualizar interfaz
            actualizarEtiquetaMAS();
            renderizarOpcionesSeleccionadas();

            // Recalcular totales
            calculateFinalTotals();
        }

        // Funci√≥n para limpiar todas las opciones MAS
        function limpiarOpcionesMAS() {
            // Desmarcar todos los checkboxes
            document.querySelectorAll('.mas-option-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });

            // Limpiar valores de todos los inputs de opciones MAS
            const inputAbono = document.getElementById('abono');
            if (inputAbono) inputAbono.value = '0';

            const inputDifPorcentaje = document.getElementById('difPorcentaje');
            if (inputDifPorcentaje) inputDifPorcentaje.value = '0';

            const inputDeposito = document.getElementById('deposito');
            if (inputDeposito) inputDeposito.value = '0';

            const inputPendiente = document.getElementById('pendiente');
            if (inputPendiente) inputPendiente.value = '0';

            // Ocultar todos los contenedores de opciones
            document.getElementById('optionAbono').classList.add('hidden');
            document.getElementById('optionDif').classList.add('hidden');
            document.getElementById('optionDeposito').classList.add('hidden');
            document.getElementById('optionPendiente').classList.add('hidden');

            // Resetear estado
            opcionesSeleccionadas = [];
            masTodasVisible = false;
            document.getElementById('masTodasOpciones').classList.add('hidden');
            document.getElementById('masArrow').style.transform = 'rotate(0deg)';

            // Actualizar interfaz
            actualizarEtiquetaMAS();
            renderizarOpcionesSeleccionadas();

            // Recalcular totales
            calculateFinalTotals();
        }

        // Funci√≥n para mostrar modal de confirmaci√≥n de reset
        function resetearFormulario() {
            document.getElementById('modalConfirmarReset').classList.remove('hidden');
        }

        // Funci√≥n para cerrar modal de reset
        function cerrarModalReset() {
            document.getElementById('modalConfirmarReset').classList.add('hidden');
        }

        // Funci√≥n para mostrar modal de confirmaci√≥n de guardar
        function mostrarModalGuardar() {
            // Actualizar resumen con datos actuales
            const totalEntradas = document.getElementById('totalEntradas').textContent;
            const totalPagos = document.getElementById('totalPagos').textContent;
            const aRecibir = document.getElementById('aRecibir').textContent;

            document.getElementById('resumenTotalEntradas').textContent = totalEntradas;
            document.getElementById('resumenTotalPagos').textContent = totalPagos;
            document.getElementById('resumenARecibir').textContent = '$' + aRecibir;

            // Mostrar modal
            document.getElementById('modalConfirmarGuardar').classList.remove('hidden');
        }

        // Funci√≥n para cerrar modal de guardar
        function cerrarModalGuardar() {
            document.getElementById('modalConfirmarGuardar').classList.add('hidden');
        }

        // Funci√≥n que ejecuta el guardado
        function ejecutarGuardarColecta() {
            cerrarModalGuardar();
            guardarColecta();
        }

        // Funci√≥n que ejecuta el reset
        function ejecutarResetearFormulario() {
            // Cerrar el modal primero
            cerrarModalReset();

            // 1. Limpiar nombre del establecimiento
            document.getElementById('nombreEstablecimiento').value = '';

            // 2. Restaurar fecha a hoy
            const fechaActual = getCurrentDate();
            const fechaActualElement = document.getElementById('fechaColecta');
            fechaActualElement.textContent = formatDateForDisplay(fechaActual);
            fechaActualElement.dataset.fechaIso = fechaActual;

            // 3. Eliminar TODAS las m√°quinas y volver al estado inicial (1 m√°quina)
            const machinesContainer = document.getElementById('machinesContainer');
            if (machinesContainer) {
                // Vaciar completamente el contenedor de m√°quinas
                machinesContainer.innerHTML = '';
            }

            // Resetear variables globales
            machines = [];
            machineCount = 0;

            // Agregar 1 m√°quina inicial (como al abrir la app)
            addSingleMachine();

            // 4. Limpiar premios pendientes
            document.getElementById('premiosPendientes').value = '';

            // 5. Limpiar campos adicionales (Estado, Impuestos, Devoluci√≥n, Fallas)
            const estadoInput = document.getElementById('estado');
            if (estadoInput) estadoInput.value = '';

            const estadoIcon = document.getElementById('estadoIcon');
            if (estadoIcon) estadoIcon.textContent = 'üì°';

            const impuestoPorMaquinaInput = document.getElementById('impuestoPorMaquina');
            if (impuestoPorMaquinaInput) impuestoPorMaquinaInput.value = '0';

            const multiplicadorImpuestoInput = document.getElementById('multiplicadorImpuesto');
            if (multiplicadorImpuestoInput) multiplicadorImpuestoInput.value = '1';

            const devolucionPorMaquinaInput = document.getElementById('devolucionPorMaquina');
            if (devolucionPorMaquinaInput) devolucionPorMaquinaInput.value = '0';

            const multiplicadorDevolucionInput = document.getElementById('multiplicadorDevolucion');
            if (multiplicadorDevolucionInput) multiplicadorDevolucionInput.value = '1';

            const fallasOPruebasInput = document.getElementById('fallasOPruebas');
            if (fallasOPruebasInput) fallasOPruebasInput.value = '0';

            // Resetear los campos calculados (readonly) tambi√©n
            const impuestoJCJInput = document.getElementById('impuestoJCJ');
            if (impuestoJCJInput) impuestoJCJInput.value = '0';

            const devolucionInput = document.getElementById('devolucion');
            if (devolucionInput) devolucionInput.value = '0';

            // 6. Limpiar opciones MAS
            limpiarOpcionesMAS();

            // 7. Resetear totales
            document.getElementById('totalEntradas').textContent = '$0.00';
            document.getElementById('totalPagos').textContent = '$0.00';
            document.getElementById('aRecibir').textContent = '0.00';

            // 8. Recalcular totales
            calculateFinalTotals();

            // 9. Mostrar notificaci√≥n de √©xito
            showSuccess('Formulario limpiado exitosamente', 'üîÑ Reseteado');
        }

        // Funci√≥n para inicializar el sistema MAS
        function inicializarSistemaMAS() {
            // Crear inputs ocultos si no existen
            const opciones = ['abono', 'dif', 'deposito', 'pendiente'];
            opciones.forEach(opcion => {
                if (!document.getElementById(opcion)) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.id = opcion;
                    input.value = '0';
                    document.body.appendChild(input);
                }
            });

            // Event listener para el bot√≥n MAS principal
            document.getElementById('btnMas').addEventListener('click', toggleTodasOpcionesMAS);

            // Event listeners para los checkboxes
            document.querySelectorAll('.mas-option-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    const opcion = this.getAttribute('data-option');
                    if (this.checked) {
                        seleccionarOpcionMAS(opcion);
                    } else {
                        deseleccionarOpcionMAS(opcion);
                    }
                });
            });

            // Tambi√©n agregar event listeners para cuando se hace clic en la etiqueta
            document.querySelectorAll('.mas-option-group').forEach(group => {
                group.addEventListener('click', function (e) {
                    // Evitar que se active dos veces
                    if (e.target.type !== 'checkbox') {
                        const checkbox = this.querySelector('.mas-option-checkbox');
                        if (checkbox) {
                            checkbox.checked = !checkbox.checked;
                            checkbox.dispatchEvent(new Event('change'));
                        }
                    }
                });
            });
        }

        // Crear inputs ocultos si no existen
        const opciones = ['abono', 'dif', 'deposito', 'pendiente'];
        opciones.forEach(opcion => {
            if (!document.getElementById(opcion)) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.id = opcion;
                input.value = '0';
                document.body.appendChild(input);
            }
        });

        // ========== FIN NUEVO SISTEMA MAS CORREGIDO ==========

        function createMachineHTML(idx) {
            return `
            <div class="card-glass rounded-xl p-3 shadow-xl">
                <div class="flex items-center justify-between mb-3 pb-2 border-b border-purple-500 border-opacity-20">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 bg-gradient-to-br from-slate-600 to-slate-500 rounded-lg flex items-center justify-center">
                            <span class="text-slate-300 font-bold text-sm">#${idx + 1}</span>
                        </div>
                        <p class="text-sm text-white font-medium">M√°quina ${idx + 1}</p>
                    </div>
                    <button class="text-red-400 hover:text-red-300 text-xs" data-remove="${idx}">üóëÔ∏è</button>
                </div>
                
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <div><label class="block text-xs font-medium text-white mb-1">Juego</label>
                        <input type="text" id="juego-${idx}" class="w-full bg-slate-700 border border-purple-500 border-opacity-30 rounded-lg px-2 py-1.5 text-white text-sm focus:outline-none focus:border-purple-500" placeholder="Nombre"></div>
                    <div><label class="block text-xs font-medium text-white mb-1">Chapa</label>
                        <input type="text" id="chapa-${idx}" class="w-full bg-slate-700 border border-purple-500 border-opacity-30 rounded-lg px-2 py-1.5 text-white text-sm focus:outline-none focus:border-purple-500" placeholder="Ig0136"></div>
                </div>

                <!-- CAJA PANTALLA -->
                <div class="bg-green-500 bg-opacity-10 border border-green-500 border-opacity-30 rounded-lg p-2 mb-2">
                    <p class="text-xs font-bold text-white mb-2 text-center">üì∫ PANTALLA</p>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div><label class="block text-xs text-white mb-1">Entrada Actual</label>
                            <input type="number" id="epa-${idx}" class="w-full bg-slate-700 border border-green-500 border-opacity-30 rounded px-2 py-1 text-white text-center font-bold focus:outline-none focus:border-green-500" placeholder="0" data-calc="${idx}"></div>
                        <div><label class="block text-xs text-white mb-1">Salida Actual</label>
                            <input type="number" id="spa-${idx}" class="w-full bg-slate-700 border border-green-500 border-opacity-30 rounded px-2 py-1 text-white text-center font-bold focus:outline-none focus:border-green-500" placeholder="0" data-calc="${idx}"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div><label class="block text-xs text-blue-200 mb-1">Entrada Anterior</label>
                            <input type="number" id="epant-${idx}" class="w-full bg-blue-900 bg-opacity-30 border border-blue-500 border-opacity-30 rounded px-2 py-1 text-white text-center font-bold focus:outline-none focus:border-blue-500" placeholder="0" data-calc="${idx}"></div>
                        <div><label class="block text-xs text-blue-200 mb-1">Salida Anterior</label>
                            <input type="number" id="spant-${idx}" class="w-full bg-blue-900 bg-opacity-30 border border-blue-500 border-opacity-30 rounded px-2 py-1 text-white text-center font-bold focus:outline-none focus:border-blue-500" placeholder="0" data-calc="${idx}"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="bg-yellow-500 bg-opacity-20 border border-yellow-500 rounded px-1 py-0.5 text-center" id="rpe-${idx}">
                            <p class="text-[10px] text-yellow-200">Resultado Entrada</p>
                            <p class="text-sm font-bold text-yellow-400" id="dpe-${idx}">0</p>
                        </div>
                        <div class="bg-yellow-500 bg-opacity-20 border border-yellow-500 rounded px-1 py-0.5 text-center" id="rps-${idx}">
                            <p class="text-[10px] text-yellow-200">Resultado Salida</p>
                            <p class="text-sm font-bold text-yellow-400" id="dps-${idx}">0</p>
                        </div>
                    </div>
                </div>

                <!-- CAJA INTERNO -->
                <div class="bg-green-500 bg-opacity-10 border border-green-500 border-opacity-30 rounded-lg p-2 mb-2">
                    <p class="text-xs font-bold text-white mb-2 text-center">üîß INTERNO</p>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div><label class="block text-xs text-white mb-1">Entrada Actual</label>
                            <input type="number" id="eia-${idx}" class="w-full bg-slate-700 border border-green-500 border-opacity-30 rounded px-2 py-1 text-white text-center font-bold focus:outline-none focus:border-green-500" placeholder="0" data-calc="${idx}"></div>
                        <div><label class="block text-xs text-white mb-1">Salida Actual</label>
                            <input type="number" id="sia-${idx}" class="w-full bg-slate-700 border border-green-500 border-opacity-30 rounded px-2 py-1 text-white text-center font-bold focus:outline-none focus:border-green-500" placeholder="0" data-calc="${idx}"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div><label class="block text-xs text-blue-200 mb-1">Entrada Anterior</label>
                            <input type="number" id="eiant-${idx}" class="w-full bg-blue-900 bg-opacity-30 border border-blue-500 border-opacity-30 rounded px-2 py-1 text-white text-center font-bold focus:outline-none focus:border-blue-500" placeholder="0" data-calc="${idx}"></div>
                        <div><label class="block text-xs text-blue-200 mb-1">Salida Anterior</label>
                            <input type="number" id="siant-${idx}" class="w-full bg-blue-900 bg-opacity-30 border border-blue-500 border-opacity-30 rounded px-2 py-1 text-white text-center font-bold focus:outline-none focus:border-blue-500" placeholder="0" data-calc="${idx}"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="bg-slate-600 bg-opacity-30 rounded px-1 py-0.5 text-center">
                            <p class="text-[10px] text-slate-300">Resultado Entrada</p>
                            <p class="text-sm font-bold text-slate-200" id="die-${idx}">0</p>
                        </div>
                        <div class="bg-slate-600 bg-opacity-30 rounded px-1 py-0.5 text-center">
                            <p class="text-[10px] text-slate-300">Resultado Salida</p>
                            <p class="text-sm font-bold text-slate-200" id="dis-${idx}">0</p>
                        </div>
                    </div>
                </div>

                <!-- GANANCIA Y % PREMIOS -->
                <div class="grid grid-cols-2 gap-2">
                    <div class="bg-green-500 bg-opacity-20 border border-green-500 rounded-lg px-2 py-2 text-center">
                        <p class="text-xs text-green-200 mb-1">Ganancia</p>
                        <p class="text-lg font-bold text-green-400" id="ganancia-${idx}">0</p>
                    </div>
                    <div class="bg-blue-500 bg-opacity-20 border border-blue-500 rounded-lg px-2 py-2 text-center">
                        <p class="text-xs text-blue-200 mb-1">% Premios</p>
                        <p class="text-lg font-bold text-blue-400" id="porcentajePremios-${idx}">0%</p>
                    </div>
                </div>
            </div>
        `;
        }

        // Modal para agregar m√°quinas
        function showAddMachineModal() {
            const activeMachines = machines.filter(m => document.getElementById('mw-' + m.index)).length;

            const modalHTML = `
<div id="machineModal" class="fixed inset-0 bg-black bg-opacity-70 z-50 p-4" style="display: flex; align-items: center; justify-content: center; overflow-y: auto;">
    <div class="card-glass rounded-xl p-4 w-full max-w-xs" style="margin: auto; position: relative;">
        <div class="flex items-center justify-between mb-3">
            <h3 class="text-base font-bold text-white">‚ûï Agregar M√°quina</h3>
            <button id="closeMachineModal" class="text-slate-400 hover:text-white text-lg">
                ‚úï
            </button>
        </div>

        <div class="space-y-3">
            <!-- Info de m√°quinas actuales -->
            <div class="flex justify-between items-center bg-slate-800 bg-opacity-40 rounded-lg px-3 py-2">
                <span class="text-xs text-slate-300">M√°quinas actuales:</span>
                <span class="font-bold text-white text-sm">${activeMachines}</span>
            </div>

            <!-- Input para cantidad -->
            <div>
                <label class="block text-xs font-medium text-white mb-1">
                    ¬øTotal de m√°quinas?
                </label>
                <div class="flex items-center gap-2">
                    <input type="number" id="machineTotal"
                        class="flex-1 bg-slate-700 border border-purple-500 border-opacity-50 rounded-lg px-3 py-2 text-white text-center font-bold focus:outline-none focus:border-purple-500"
                        min="${activeMachines + 1}" max="20" value="${activeMachines + 1}">
                    <span class="text-xs text-slate-400 whitespace-nowrap">/ 20 m√°x</span>
                </div>
            </div>
            
            <!-- Info de agregar -->
            <div class="bg-gradient-to-r from-blue-900/30 to-cyan-900/30 rounded-lg p-2 text-center">
                <p class="text-xs text-slate-300">
                    Se agregar√°n: <span id="machinesToAdd" class="font-bold text-green-400">1</span> m√°quina(s)
                </p>
            </div>
        </div>
        
        <div class="grid grid-cols-2 gap-2 mt-4">
            <button id="cancelModal" 
                class="bg-slate-700 text-white font-semibold py-2 rounded-lg hover:bg-slate-600 transition-all text-xs">
                Cancelar
            </button>
            <button id="confirmAdd" 
                class="bg-gradient-to-r from-blue-600 to-cyan-600 text-white font-semibold py-2 rounded-lg hover:from-blue-700 hover:to-cyan-700 transition-all text-xs">
                Agregar
            </button>
        </div>
    </div>
</div>
`;

            // Verificar si ya hay un modal abierto
            if (document.getElementById('machineModal')) {
                return;
            }

            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // NO enfocar autom√°ticamente para evitar que el teclado empuje el modal
            // El usuario puede hacer click cuando lo necesite

            // Funci√≥n para actualizar el c√°lculo de m√°quinas a agregar
            function updateMachinesToAdd() {
                const totalDeseado = parseInt(document.getElementById('machineTotal').value) || activeMachines + 1;
                const maquinasAAgregar = Math.max(0, totalDeseado - activeMachines);
                document.getElementById('machinesToAdd').textContent = maquinasAAgregar;
            }

            // Actualizar al cargar
            updateMachinesToAdd();

            // Event listener para actualizar en tiempo real
            document.getElementById('machineTotal').addEventListener('input', updateMachinesToAdd);

            // Event listeners para el modal
            document.getElementById('closeMachineModal').addEventListener('click', function () {
                const modal = document.getElementById('machineModal');
                if (modal) modal.remove();
            });

            document.getElementById('cancelModal').addEventListener('click', function () {
                const modal = document.getElementById('machineModal');
                if (modal) modal.remove();
            });

            document.getElementById('confirmAdd').addEventListener('click', function () {
                const totalDeseado = parseInt(document.getElementById('machineTotal').value) || activeMachines + 1;
                const maquinasAAgregar = Math.max(0, totalDeseado - activeMachines);
                const modal = document.getElementById('machineModal');
                if (modal) modal.remove();

                // Agregar las m√°quinas necesarias
                for (let i = 0; i < maquinasAAgregar; i++) {
                    addSingleMachine();
                }
            });

            // Cerrar modal con Escape
            function closeModalOnEscape(e) {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('machineModal');
                    if (modal) modal.remove();
                    document.removeEventListener('keydown', closeModalOnEscape);
                }
            }

            document.addEventListener('keydown', closeModalOnEscape);

            // Cerrar modal haciendo clic fuera
            const modalElement = document.getElementById('machineModal');
            if (modalElement) {
                modalElement.addEventListener('click', function (e) {
                    if (e.target.id === 'machineModal') {
                        this.remove();
                        document.removeEventListener('keydown', closeModalOnEscape);
                    }
                });
            }
        }

        function addSingleMachine() {
            const c = document.getElementById('machinesContainer');
            const d = document.createElement('div');
            d.id = 'mw-' + machineCount;
            d.innerHTML = createMachineHTML(machineCount);
            c.appendChild(d);
            machines.push({ index: machineCount });

            // Agregar event listeners a los inputs de ESTA m√°quina espec√≠fica
            const newMachineIndex = machineCount;

            // Seleccionar todos los inputs de esta m√°quina
            const inputs = d.querySelectorAll('input[data-calc]');
            inputs.forEach(input => {
                input.addEventListener('input', function () {
                    setTimeout(() => calc(newMachineIndex), 50);
                });
            });

            machineCount++;

            // Calcular esta m√°quina inmediatamente
            setTimeout(() => calc(newMachineIndex), 100);

            // Actualizar multiplicadores autom√°ticamente
            updateTotals();
        }
        function removeMachine(idx) {
            // Crear notificaci√≥n de confirmaci√≥n
            const confirmId = 'confirm-remove-' + Date.now();
            const confirmHTML = `
        <div id="${confirmId}" class="notification notification-warning show" style="max-width: 350px;">
            <div class="notification-content">
                <div class="notification-icon">üóëÔ∏è</div>
                <div class="notification-text">
                    <div class="notification-title">¬øEliminar m√°quina #${idx + 1}?</div>
                    <div class="notification-message">
                        Esta acci√≥n eliminar√° la m√°quina y sus datos.
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                        <button onclick="document.getElementById('${confirmId}').remove();" 
                            class="flex-1 bg-slate-700 hover:bg-slate-600 text-white text-xs font-medium py-2 rounded-lg transition-all">
                            Cancelar
                        </button>
                        <button onclick="
                            document.getElementById('${confirmId}').remove();
                            const machineElement = document.getElementById('mw-' + ${idx});
                            if (machineElement) {
                                machineElement.remove();
                                machines = machines.filter(function (m) { return m.index !== ${idx}; });
                                updateTotals();
                                showInfo('M√°quina #${idx + 1} eliminada', 'üóëÔ∏è Eliminado');
                            } else {
                                console.warn('No se encontr√≥ la m√°quina con √≠ndice:', ${idx});
                            }
                        " 
                            class="flex-1 bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-700 hover:to-orange-700 text-white text-xs font-medium py-2 rounded-lg transition-all">
                            S√≠, Eliminar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

            let container = document.getElementById('notification-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'notification-container';
                container.className = 'notification-container';
                document.body.appendChild(container);
            }

            container.insertAdjacentHTML('afterbegin', confirmHTML);
        }

        function calc(i) {
            const epa = parseFloat(document.getElementById('epa-' + i).value) || 0;
            const spa = parseFloat(document.getElementById('spa-' + i).value) || 0;
            const epant = parseFloat(document.getElementById('epant-' + i).value) || 0;
            const spant = parseFloat(document.getElementById('spant-' + i).value) || 0;
            const eia = parseFloat(document.getElementById('eia-' + i).value) || 0;
            const sia = parseFloat(document.getElementById('sia-' + i).value) || 0;
            const eiant = parseFloat(document.getElementById('eiant-' + i).value) || 0;
            const siant = parseFloat(document.getElementById('siant-' + i).value) || 0;

            const dpe = epa - epant;
            const dps = spa - spant;
            const die = eia - eiant;
            const dis = sia - siant;

            document.getElementById('dpe-' + i).textContent = dpe.toFixed(2);  // Pantalla con decimales
            document.getElementById('dps-' + i).textContent = dps.toFixed(2);  // Pantalla con decimales
            document.getElementById('die-' + i).textContent = Math.round(die);  // Interno sin decimales
            document.getElementById('dis-' + i).textContent = Math.round(dis);  // Interno sin decimales

            // Calcular ganancia (Entrada pantalla - Salida pantalla)
            const ganancia = dpe - dps;
            const gananciaElement = document.getElementById('ganancia-' + i);
            gananciaElement.textContent = ganancia.toFixed(2);

            // Cambiar color seg√∫n ganancia
            if (ganancia > 0) {
                gananciaElement.className = 'text-sm font-bold text-green-400';
                gananciaElement.parentElement.className = 'bg-green-500 bg-opacity-20 border border-green-500 rounded px-1 py-0.5 text-center';
            } else if (ganancia < 0) {
                gananciaElement.className = 'text-sm font-bold text-red-400';
                gananciaElement.parentElement.className = 'bg-red-500 bg-opacity-20 border border-red-500 rounded px-1 py-0.5 text-center';
            } else {
                gananciaElement.className = 'text-sm font-bold text-yellow-400';
                gananciaElement.parentElement.className = 'bg-yellow-500 bg-opacity-20 border border-yellow-500 rounded px-1 py-0.5 text-center';
            }

            // Calcular porcentaje de premios (Salida pantalla / Entrada pantalla * 100)
            const porcentajeElement = document.getElementById('porcentajePremios-' + i);
            let porcentajePremios = 0;
            if (dpe > 0) {
                porcentajePremios = (dps / dpe) * 100;
            }
            porcentajeElement.textContent = porcentajePremios.toFixed(1) + '%';

            // Cambiar color seg√∫n porcentaje de premios
            if (porcentajePremios > 100) {
                porcentajeElement.className = 'text-sm font-bold text-red-400';
                porcentajeElement.parentElement.className = 'bg-red-500 bg-opacity-20 border border-red-500 rounded px-1 py-0.5 text-center';
            } else if (porcentajePremios > 80) {
                porcentajeElement.className = 'text-sm font-bold text-yellow-400';
                porcentajeElement.parentElement.className = 'bg-yellow-500 bg-opacity-20 border border-yellow-500 rounded px-1 py-0.5 text-center';
            } else {
                porcentajeElement.className = 'text-sm font-bold text-blue-400';
                porcentajeElement.parentElement.className = 'bg-blue-500 bg-opacity-20 border border-blue-500 rounded px-1 py-0.5 text-center';
            }

            validate(i, 'e', dpe, die);
            validate(i, 's', dps, dis);
            updateTotals();
        }

        function validate(i, t, pv, iv) {
            const pel = document.getElementById('rp' + t + '-' + i);
            const match = (pv === iv) || (pv * 10 === iv) || (pv === iv / 10);
            if (match) {
                pel.className = 'bg-green-500 border border-green-500 rounded px-2 py-1 text-center';
                document.getElementById('dp' + t + '-' + i).className = 'text-sm font-bold text-white'; // ‚Üê CAMBIADO
            } else if (pv !== 0 || iv !== 0) {
                pel.className = 'bg-red-500 border border-red-500 rounded px-2 py-1 text-center';
                document.getElementById('dp' + t + '-' + i).className = 'text-sm font-bold text-white'; // ‚Üê CAMBIADO
            } else {
                pel.className = 'bg-yellow-500 bg-opacity-20 border border-yellow-500 rounded px-2 py-1 text-center';
                document.getElementById('dp' + t + '-' + i).className = 'text-sm font-bold text-yellow-400'; // ‚Üê CAMBIADO
            }
        }

        function updateTotals() {
            let totalE = 0;
            let totalP = 0;
            let activeMachines = 0;

            for (var i = 0; i < machines.length; i++) {
                var m = machines[i];
                if (document.getElementById('mw-' + m.index)) {
                    const dpe = parseFloat(document.getElementById('dpe-' + m.index).textContent) || 0;
                    const dps = parseFloat(document.getElementById('dps-' + m.index).textContent) || 0;
                    totalE += dpe;
                    totalP += dps;
                    activeMachines++;
                }
            }

            document.getElementById('totalEntradas').textContent = '$' + totalE.toFixed(2);
            document.getElementById('totalPagos').textContent = '$' + totalP.toFixed(2);

            // Si no hay m√°quinas activas, resetear multiplicadores
            if (activeMachines === 0) {
                resetearMultiplicadorManual('multiplicadorImpuesto');
                resetearMultiplicadorManual('multiplicadorDevolucion');
                document.getElementById('multiplicadorImpuesto').value = 1;
                document.getElementById('multiplicadorDevolucion').value = 1;
            } else {
                // Actualizar multiplicadores autom√°ticamente (solo si no fueron modificados manualmente)
                actualizarMultiplicadores();
            }

            // Calcular totales finales
            calculateFinalTotals();
        }
        // Funci√≥n para recalcular valores cuando cambia la cantidad de m√°quinas
        function calcularValoresPorMaquina() {
            const impuestoInput = document.getElementById('impuestoJCJ');
            const devolucionInput = document.getElementById('devolucion');
            const activeMachines = machines.filter(m => document.getElementById('mw-' + m.index)).length;

            if (activeMachines > 0) {
                // Obtener valores por m√°quina
                const impuestoPorMaquina = parseFloat(impuestoInput.getAttribute('data-base-per-machine')) || 0;
                const devolucionPorMaquina = parseFloat(devolucionInput.getAttribute('data-base-per-machine')) || 0;

                // Calcular nuevos valores totales
                const nuevoImpuestoTotal = (impuestoPorMaquina * activeMachines).toFixed(2);
                const nuevaDevolucionTotal = (devolucionPorMaquina * activeMachines).toFixed(2);

                // Actualizar los inputs
                impuestoInput.value = nuevoImpuestoTotal;
                devolucionInput.value = nuevaDevolucionTotal;
            } else {
                // Si no hay m√°quinas, poner en 0
                impuestoInput.value = '0';
                devolucionInput.value = '0';
            }
        }

        // Funci√≥n para actualizar el c√°lculo del impuesto
        function calcularImpuestoTotal() {
            const valorPorMaquina = parseFloat(document.getElementById('impuestoPorMaquina').value) || 0;
            const multiplicador = parseFloat(document.getElementById('multiplicadorImpuesto').value) || 1;
            const total = valorPorMaquina * multiplicador;

            document.getElementById('impuestoJCJ').value = total.toFixed(2);
            calculateFinalTotals();
        }

        // Funci√≥n para actualizar el c√°lculo de la devoluci√≥n
        function calcularDevolucionTotal() {
            const valorPorMaquina = parseFloat(document.getElementById('devolucionPorMaquina').value) || 0;
            const multiplicador = parseFloat(document.getElementById('multiplicadorDevolucion').value) || 1;
            const total = valorPorMaquina * multiplicador;

            document.getElementById('devolucion').value = total.toFixed(2);
            calculateFinalTotals();
        }

        // Funci√≥n para marcar multiplicador como modificado manualmente
        function marcarMultiplicadorManual(inputId) {
            const input = document.getElementById(inputId);
            input.setAttribute('data-manual', 'true');
        }

        // Funci√≥n para resetear multiplicador manual
        function resetearMultiplicadorManual(inputId) {
            const input = document.getElementById(inputId);
            input.removeAttribute('data-manual');
        }

        // Funci√≥n para actualizar los multiplicadores con la cantidad de m√°quinas
        function actualizarMultiplicadores() {
            const activeMachines = machines.filter(m => document.getElementById('mw-' + m.index)).length || 1;

            // Solo actualizar si el usuario no ha modificado manualmente
            const multiplicadorImpuesto = document.getElementById('multiplicadorImpuesto');
            const multiplicadorDevolucion = document.getElementById('multiplicadorDevolucion');

            // Verificar si el usuario ha modificado manualmente
            if (!multiplicadorImpuesto.hasAttribute('data-manual')) {
                multiplicadorImpuesto.value = activeMachines;
            }

            if (!multiplicadorDevolucion.hasAttribute('data-manual')) {
                multiplicadorDevolucion.value = activeMachines;
            }

            // Recalcular los totales
            calcularImpuestoTotal();
            calcularDevolucionTotal();
        }

        function calculateFinalTotals() {
            const totalE = parseFloat(document.getElementById('totalEntradas').textContent.replace('$', '')) || 0;
            const totalP = parseFloat(document.getElementById('totalPagos').textContent.replace('$', '')) || 0;
            console.log('calculateFinalTotals - totalE:', totalE, 'totalP:', totalP);
            const impuesto = parseFloat(document.getElementById('impuestoJCJ').value) || 0; // ‚Üê Usa este
            const devolucion = parseFloat(document.getElementById('devolucion').value) || 0; // ‚Üê Usa este
            const fallas = parseFloat(document.getElementById('fallasOPruebas').value) || 0;
            const premiosPend = parseFloat(document.getElementById('premiosPendientes').value) || 0;
            const abono = parseFloat(document.getElementById('abono').value) || 0;
            const difPorc = parseFloat(document.getElementById('difPorcentaje').value) || 0;
            const deposito = parseFloat(document.getElementById('deposito').value) || 0;
            const pendiente = parseFloat(document.getElementById('pendiente').value) || 0;

            const colectado = totalE - fallas;
            const premios = totalP + premiosPend;
            const retencion = (totalP * 5.5) / 100;
            const premiosNeto = premios - retencion;
            const aRepartir = totalE - totalP - impuesto - devolucion;
            const gananciaCU = aRepartir / 2;
            const gananciaCliente = gananciaCU + devolucion;
            const recibidoCliente = gananciaCU + devolucion + premiosNeto;
            const empresaJCJ = gananciaCU + impuesto;
            const recibidoEmpresa = gananciaCU + impuesto + retencion;
            const aRecibir = recibidoEmpresa + abono - deposito - pendiente - difPorc;

            document.getElementById('colectado').textContent = colectado.toFixed(2);
            document.getElementById('premios').textContent = premios.toFixed(2);
            document.getElementById('retencion').textContent = retencion.toFixed(2);
            document.getElementById('premiosNeto').textContent = premiosNeto.toFixed(2);
            document.getElementById('impuestoDisplay').textContent = impuesto.toFixed(2);
            document.getElementById('devolucionDisplay').textContent = devolucion.toFixed(2);
            document.getElementById('aRepartir').textContent = aRepartir.toFixed(2);
            document.getElementById('gananciaCU').textContent = gananciaCU.toFixed(2);
            document.getElementById('gananciaCliente').textContent = gananciaCliente.toFixed(2);
            document.getElementById('recibidoCliente').textContent = recibidoCliente.toFixed(2);
            document.getElementById('empresaJCJ').textContent = empresaJCJ.toFixed(2);
            document.getElementById('recibidoEmpresa').textContent = recibidoEmpresa.toFixed(2);
            document.getElementById('aRecibir').textContent = aRecibir.toFixed(2);

        }

        // Inicializar cuando el DOM est√© cargado
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Colecta App v2.0 iniciada');

            // ========== INICIALIZACI√ìN DEL DASHBOARD ==========
            // Empezar mostrando el dashboard
            navigateTo('dashboard');

            // Inicializar multiplicadores
            document.getElementById('multiplicadorImpuesto').value = 1;
            document.getElementById('multiplicadorDevolucion').value = 1;

            // Establecer fecha actual SOLO en la tarjeta del establecimiento
            const fechaActual = getCurrentDate(); // Formato ISO: 2026-01-26
            const fechaActualElement = document.getElementById('fechaColecta');
            fechaActualElement.textContent = formatDateForDisplay(fechaActual); // Mostrar: 26 ene 2026
            fechaActualElement.dataset.fechaIso = fechaActual; // Guardar ISO en data attribute

            // Inicializar con 1 m√°quina por defecto (para cuando se abra la p√°gina de colecta)
            addSingleMachine();

            // Calcular totales iniciales
            setTimeout(() => {
                calculateFinalTotals();
            }, 300);

            // Configurar event listeners

            // Bot√≥n Agregar M√°quina
            document.getElementById('btnAdd').addEventListener('click', function () {
                showAddMachineModal();
            });

            // Inicializar nuevo sistema MAS
            inicializarSistemaMAS();

            // ===== EVENT DELEGATION PARA INPUTS DE M√ÅQUINAS =====
            document.addEventListener('input', function (e) {
                // Verificar si el input tiene el atributo data-calc (que indica que pertenece a una m√°quina)
                if (e.target.hasAttribute('data-calc')) {
                    const machineIndex = parseInt(e.target.getAttribute('data-calc'));
                    if (!isNaN(machineIndex)) {
                        // Calcular para esta m√°quina espec√≠fica
                        calc(machineIndex);
                    }
                }
            });

            // Tambi√©n manejar eventos de cambio para inputs de m√°quina
            document.getElementById('machinesContainer').addEventListener('input', function (e) {
                if (e.target.hasAttribute('data-calc')) {
                    const machineIndex = parseInt(e.target.getAttribute('data-calc'));
                    if (!isNaN(machineIndex)) {
                        setTimeout(() => calc(machineIndex), 50); // Peque√±o delay para asegurar que el valor est√© actualizado
                    }
                }
            });

            // Event delegation para eliminar m√°quinas (mejorado)
            document.getElementById('machinesContainer').addEventListener('click', function (e) {
                if (e.target.dataset.remove !== undefined) {
                    const idx = parseInt(e.target.dataset.remove);
                    if (!isNaN(idx)) {
                        removeMachine(idx);
                    }
                }
            });

            // Asegurar que las m√°quinas iniciales se calculen
            setTimeout(() => {
                // Calcular todas las m√°quinas existentes
                for (let i = 0; i < machineCount; i++) {
                    if (document.getElementById('epa-' + i)) {
                        calc(i);
                    }
                }
            }, 300);

            // ===== NUEVOS EVENT LISTENERS PARA EL SISTEMA DE MULTIPLICADORES =====

            // Event listeners para Impuesto JCJ
            document.getElementById('impuestoPorMaquina').addEventListener('input', calcularImpuestoTotal);

            document.getElementById('multiplicadorImpuesto').addEventListener('input', function () {
                marcarMultiplicadorManual('multiplicadorImpuesto');
                calcularImpuestoTotal();
            });

            document.getElementById('multiplicadorImpuesto').addEventListener('focus', function () {
                marcarMultiplicadorManual('multiplicadorImpuesto');
            });

            // Event listeners para Devoluci√≥n
            document.getElementById('devolucionPorMaquina').addEventListener('input', calcularDevolucionTotal);

            document.getElementById('multiplicadorDevolucion').addEventListener('input', function () {
                marcarMultiplicadorManual('multiplicadorDevolucion');
                calcularDevolucionTotal();
            });

            document.getElementById('multiplicadorDevolucion').addEventListener('focus', function () {
                marcarMultiplicadorManual('multiplicadorDevolucion');
            });

            // Este c√≥digo ya no es necesario para btnReset
            // Se mantiene comentado para referencia

            // ===== FIN NUEVOS EVENT LISTENERS =====

            // Event listeners para otros inputs (los originales, ajustados)
            // NOTA: Ya no necesitamos estos event listeners para impuestoJCJ y devoluci√≥n
            // porque ahora se calculan autom√°ticamente
            document.getElementById('fallasOPruebas').addEventListener('input', calculateFinalTotals);
            document.getElementById('premiosPendientes').addEventListener('input', calculateFinalTotals);
            document.getElementById('abono').addEventListener('input', calculateFinalTotals);
            document.getElementById('difPorcentaje').addEventListener('input', calculateFinalTotals);
            document.getElementById('deposito').addEventListener('input', calculateFinalTotals);
            document.getElementById('pendiente').addEventListener('input', calculateFinalTotals);

            // Bot√≥n Ver Anteriores
            document.getElementById('btnVerAnteriores').addEventListener('click', function () {
                cargarListaEstablecimientos();
            });

            // Bot√≥n Compartir
            document.getElementById('btnCompartir').addEventListener('click', function () {
                generarImagenParaCompartir();
            });

            // Bot√≥n Reset
            document.getElementById('btnReset').addEventListener('click', function () {
                resetearFormulario();
            });

            document.getElementById('btnSave').addEventListener('click', function () {
                mostrarModalGuardar();
            });

            // Event delegation para botones eliminar opciones MAS
            document.addEventListener('click', function (e) {
                // Eliminar opciones MAS (evitar conflicto)
                if (e.target.dataset.removeMas !== undefined) {
                    // Este evento ya se maneja en renderizarOpcionesSeleccionadas
                    return;
                }
            });
        }); // <--- √öNICO cierre de DOMContentLoaded
    </script>
</body>

</html>
